<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="utf-8">
    <title>app/js/bus/network/keyBroadcastLocalStorageLink.js - ozpIwc</title>
    <link rel="stylesheet" href="http://yui.yahooapis.com/3.9.1/build/cssgrids/cssgrids-min.css">
    <link rel="stylesheet" href="../assets/vendor/prettify/prettify-min.css">
    <link rel="stylesheet" href="../assets/css/main.css" id="site_styles">
    <link rel="shortcut icon" type="image/png" href="../assets/favicon.png">
    <script src="http://yui.yahooapis.com/combo?3.9.1/build/yui/yui-min.js"></script>
</head>
<body class="yui3-skin-sam">

<div id="doc">
    <div id="hd" class="yui3-g header">
        <div class="yui3-u-3-4">
            
                <h1><img src="../assets/css/logo.png" title="ozpIwc"></h1>
            
        </div>
        <div class="yui3-u-1-4 version">
            <em>API Docs for: 0.2.4</em>
        </div>
    </div>
    <div id="bd" class="yui3-g">

        <div class="yui3-u-1-4">
            <div id="docs-sidebar" class="sidebar apidocs">
                <div id="api-list">
    <h2 class="off-left">APIs</h2>
    <div id="api-tabview" class="tabview">
        <ul class="tabs">
            <li><a href="#api-classes">Classes</a></li>
            <li><a href="#api-modules">Modules</a></li>
        </ul>

        <div id="api-tabview-filter">
            <input type="search" id="api-filter" placeholder="Type to filter APIs">
        </div>

        <div id="api-tabview-panel">
            <ul id="api-classes" class="apis classes">
            
                <li><a href="../classes/ozpIwc.ApiError.html">ozpIwc.ApiError</a></li>
            
                <li><a href="../classes/ozpIwc.AsyncAction.html">ozpIwc.AsyncAction</a></li>
            
                <li><a href="../classes/ozpIwc.CancelableEvent.html">ozpIwc.CancelableEvent</a></li>
            
                <li><a href="../classes/ozpIwc.Client.html">ozpIwc.Client</a></li>
            
                <li><a href="../classes/ozpIwc.CommonApiBase.html">ozpIwc.CommonApiBase</a></li>
            
                <li><a href="../classes/ozpIwc.CommonApiCollectionValue.html">ozpIwc.CommonApiCollectionValue</a></li>
            
                <li><a href="../classes/ozpIwc.CommonApiValue.html">ozpIwc.CommonApiValue</a></li>
            
                <li><a href="../classes/ozpIwc.DataApi.html">ozpIwc.DataApi</a></li>
            
                <li><a href="../classes/ozpIwc.DataApiValue.html">ozpIwc.DataApiValue</a></li>
            
                <li><a href="../classes/ozpIwc.Endpoint.html">ozpIwc.Endpoint</a></li>
            
                <li><a href="../classes/ozpIwc.EndpointRegistry.html">ozpIwc.EndpointRegistry</a></li>
            
                <li><a href="../classes/ozpIwc.Event.html">ozpIwc.Event</a></li>
            
                <li><a href="../classes/ozpIwc.FragmentPacket.html">ozpIwc.FragmentPacket</a></li>
            
                <li><a href="../classes/ozpIwc.FragmentStore.html">ozpIwc.FragmentStore</a></li>
            
                <li><a href="../classes/ozpIwc.IntentsApi.html">ozpIwc.IntentsApi</a></li>
            
                <li><a href="../classes/ozpIwc.IntentsApiDefinitionValue.html">ozpIwc.IntentsApiDefinitionValue</a></li>
            
                <li><a href="../classes/ozpIwc.IntentsApiHandlerValue.html">ozpIwc.IntentsApiHandlerValue</a></li>
            
                <li><a href="../classes/ozpIwc.IntentsApiTypeValue.html">ozpIwc.IntentsApiTypeValue</a></li>
            
                <li><a href="../classes/ozpIwc.InternalParticipant.html">ozpIwc.InternalParticipant</a></li>
            
                <li><a href="../classes/ozpIwc.KeyBroadcastLocalStorageLink.html">ozpIwc.KeyBroadcastLocalStorageLink</a></li>
            
                <li><a href="../classes/ozpIwc.LeaderGroupParticipant.html">ozpIwc.LeaderGroupParticipant</a></li>
            
                <li><a href="../classes/ozpIwc.LocalStorageLink.html">ozpIwc.LocalStorageLink</a></li>
            
                <li><a href="../classes/ozpIwc.log.html">ozpIwc.log</a></li>
            
                <li><a href="../classes/ozpIwc.MetricsRegistry.html">ozpIwc.MetricsRegistry</a></li>
            
                <li><a href="../classes/ozpIwc.metricsStats.Sample.html">ozpIwc.metricsStats.Sample</a></li>
            
                <li><a href="../classes/ozpIwc.metricsStats.UniformSample.html">ozpIwc.metricsStats.UniformSample</a></li>
            
                <li><a href="../classes/ozpIwc.metricStats.html">ozpIwc.metricStats</a></li>
            
                <li><a href="../classes/ozpIwc.metricStats.BinaryHeap.html">ozpIwc.metricStats.BinaryHeap</a></li>
            
                <li><a href="../classes/ozpIwc.metricStats.ExponentiallyDecayingSample.html">ozpIwc.metricStats.ExponentiallyDecayingSample</a></li>
            
                <li><a href="../classes/ozpIwc.metricTypes.BaseMetric.html">ozpIwc.metricTypes.BaseMetric</a></li>
            
                <li><a href="../classes/ozpIwc.metricTypes.Counter.html">ozpIwc.metricTypes.Counter</a></li>
            
                <li><a href="../classes/ozpIwc.metricTypes.Gauge.html">ozpIwc.metricTypes.Gauge</a></li>
            
                <li><a href="../classes/ozpIwc.metricTypes.Histogram.html">ozpIwc.metricTypes.Histogram</a></li>
            
                <li><a href="../classes/ozpIwc.metricTypes.Meter.html">ozpIwc.metricTypes.Meter</a></li>
            
                <li><a href="../classes/ozpIwc.MulticastParticipant.html">ozpIwc.MulticastParticipant</a></li>
            
                <li><a href="../classes/ozpIwc.NamesApi.html">ozpIwc.NamesApi</a></li>
            
                <li><a href="../classes/ozpIwc.NamesApiValue.html">ozpIwc.NamesApiValue</a></li>
            
                <li><a href="../classes/ozpIwc.NetworkPacket.html">ozpIwc.NetworkPacket</a></li>
            
                <li><a href="../classes/ozpIwc.packetRouter.html">ozpIwc.packetRouter</a></li>
            
                <li><a href="../classes/ozpIwc.PacketRouter.html">ozpIwc.PacketRouter</a></li>
            
                <li><a href="../classes/ozpIwc.Participant.html">ozpIwc.Participant</a></li>
            
                <li><a href="../classes/ozpIwc.Peer.html">ozpIwc.Peer</a></li>
            
                <li><a href="../classes/ozpIwc.policyAuth.PDP.html">ozpIwc.policyAuth.PDP</a></li>
            
                <li><a href="../classes/ozpIwc.policyAuth.SecurityAttribute.html">ozpIwc.policyAuth.SecurityAttribute</a></li>
            
                <li><a href="../classes/ozpIwc.PostMessageParticipant.html">ozpIwc.PostMessageParticipant</a></li>
            
                <li><a href="../classes/ozpIwc.PostMessageParticipantListener.html">ozpIwc.PostMessageParticipantListener</a></li>
            
                <li><a href="../classes/ozpIwc.Router.html">ozpIwc.Router</a></li>
            
                <li><a href="../classes/ozpIwc.RouterWatchdog.html">ozpIwc.RouterWatchdog</a></li>
            
                <li><a href="../classes/ozpIwc.SystemApi.html">ozpIwc.SystemApi</a></li>
            
                <li><a href="../classes/ozpIwc.SystemApiApplicationValue.html">ozpIwc.SystemApiApplicationValue</a></li>
            
                <li><a href="../classes/ozpIwc.Timer.html">ozpIwc.Timer</a></li>
            
                <li><a href="../classes/ozpIwc.TransportPacket.html">ozpIwc.TransportPacket</a></li>
            
                <li><a href="../classes/ozpIwc.TransportPacketContext.html">ozpIwc.TransportPacketContext</a></li>
            
                <li><a href="../classes/ozpIwc.util.html">ozpIwc.util</a></li>
            
                <li><a href="../classes/ozpIwcPolicies.html">ozpIwcPolicies</a></li>
            
            </ul>

            <ul id="api-modules" class="apis modules">
            
                <li><a href="../modules/bus.html">bus</a></li>
            
                <li><a href="../modules/bus.api.html">bus.api</a></li>
            
                <li><a href="../modules/bus.api.Type.html">bus.api.Type</a></li>
            
                <li><a href="../modules/bus.api.Value.html">bus.api.Value</a></li>
            
                <li><a href="../modules/bus.network.html">bus.network</a></li>
            
                <li><a href="../modules/bus.network.packets.html">bus.network.packets</a></li>
            
                <li><a href="../modules/bus.security.html">bus.security</a></li>
            
                <li><a href="../modules/bus.transport.html">bus.transport</a></li>
            
                <li><a href="../modules/bus.util.html">bus.util</a></li>
            
                <li><a href="../modules/client.html">client</a></li>
            
                <li><a href="../modules/common.html">common</a></li>
            
                <li><a href="../modules/metrics.html">metrics</a></li>
            
                <li><a href="../modules/metrics.statistics.html">metrics.statistics</a></li>
            
                <li><a href="../modules/metrics.types.html">metrics.types</a></li>
            
            </ul>
        </div>
    </div>
</div>

            </div>
        </div>
        <div class="yui3-u-3-4">
                <div id="api-options">
        Show:
        <label for="api-show-inherited">
            <input type="checkbox" id="api-show-inherited" checked>
            Inherited
        </label>

        <label for="api-show-protected">
            <input type="checkbox" id="api-show-protected">
            Protected
        </label>

        <label for="api-show-private">
            <input type="checkbox" id="api-show-private">
            Private
        </label>
        <label for="api-show-deprecated">
            <input type="checkbox" id="api-show-deprecated">
            Deprecated
        </label>

    </div>


            <div class="apidocs">
                <div id="docs-main">
                    <div class="content">
                        <h1 class="file-heading">File: app/js/bus/network/keyBroadcastLocalStorageLink.js</h1>

<div class="file">
    <pre class="code prettyprint linenums">
/** @namespace **/

/**
 * Classes related to security aspects of the IWC.
 * @module bus
 * @submodule bus.network
 */

/**
 * &lt;p&gt;This link connects peers using the HTML5 localstorage API.  It is a second generation version of
 * the localStorageLink that bypasses most of the garbage collection issues.
 *
 * &lt;p&gt; When a packet is sent, this link turns it to a string, creates a key with that value, and
 * immediately deletes it.  This still sends the storage event containing the packet as the key.
 * This completely eliminates the need to garbage collect the localstorage space, with the associated
 * mutex contention and full-buffer issues.
 *
 * @todo Compress the key
 *
 * @class KeyBroadcastLocalStorageLink
 * @namespace ozpIwc
 * @constructor
 *
 * @param {Object} [config] Configuration for this link
 * @param {ozpIwc.Peer} [config.peer=ozpIwc.defaultPeer] The peer to connect to.
 * @param {String} [config.prefix=&#x27;ozpIwc&#x27;] Namespace for communicating, must be the same for all peers on the same network.
 * @param {String} [config.selfId] Unique name within the peer network.  Defaults to the peer id.
 * @param {Number} [config.maxRetries] Number of times packet transmission will retry if failed. Defaults to 6.
 * @param {Number} [config.queueSize] Number of packets allowed to be queued at one time. Defaults to 1024.
 * @param {Number} [config.fragmentSize] Size in bytes of which any TransportPacket exceeds will be sent in FragmentPackets.
 * @param {Number} [config.fragmentTime] Time in milliseconds after a fragment is received and additional expected
 * fragments are not received that the message is dropped.
 */
ozpIwc.KeyBroadcastLocalStorageLink = function (config) {
    config = config || {};

    /**
     * Namespace for communicating, must be the same for all peers on the same network.
     * @property prefix
     * @type String
     * @default &quot;ozpIwc&quot;
     */
    this.prefix = config.prefix || &#x27;ozpIwc&#x27;;

    /**
     * The peer this link will connect to.
     * @property peer
     * @type ozpIwc.Peer
     * @default ozpIwc.defaultPeer
     */
    this.peer = config.peer || ozpIwc.defaultPeer;

    /**
     * Unique name within the peer network.  Defaults to the peer id.
     * @property selfId
     * @type String
     * @default ozpIwc.defaultPeer.selfId
     */
    this.selfId = config.selfId || this.peer.selfId;

    this.metricsPrefix=&quot;keyBroadcastLocalStorageLink.&quot;+this.selfId;
    this.droppedFragmentsCounter=ozpIwc.metrics.counter(this.metricsPrefix,&#x27;fragmentsDropped&#x27;);
    this.fragmentsReceivedCounter=ozpIwc.metrics.counter(this.metricsPrefix,&#x27;fragmentsReceived&#x27;);

    this.packetsSentCounter=ozpIwc.metrics.counter(this.metricsPrefix,&#x27;packetsSent&#x27;);
    this.packetsReceivedCounter=ozpIwc.metrics.counter(this.metricsPrefix,&#x27;packetsReceived&#x27;);
    this.packetParseErrorCounter=ozpIwc.metrics.counter(this.metricsPrefix,&#x27;packetsParseError&#x27;);
    this.packetsFailedCounter=ozpIwc.metrics.counter(this.metricsPrefix,&#x27;packetsFailed&#x27;);
    
    this.latencyInTimer=ozpIwc.metrics.timer(this.metricsPrefix,&#x27;latencyIn&#x27;);
    this.latencyOutTimer=ozpIwc.metrics.timer(this.metricsPrefix,&#x27;latencyOut&#x27;);
    /**
     * Milliseconds to wait before deleting this link&#x27;s keys
     * @todo UNUSUED
     * @property myKeysTimeout
     * @type Number
     * @default 5000
     */
    this.myKeysTimeout = config.myKeysTimeout || 5000; // 5 seconds

    /**
     * Milliseconds to wait before deleting other link&#x27;s keys
     * @todo UNUSUED
     * @property otherKeysTimeout
     * @type Number
     * @default 120000
     */
    this.otherKeysTimeout = config.otherKeysTimeout || 2 * 60000; // 2 minutes


    /**
     * The maximum number of retries the link will take to send a package. A timeout of
     * max(1, 2^( &lt;retry count&gt; -1) - 1) milliseconds occurs between send attempts.
     * @property maxRetries
     * @type Number
     * @default 6
     */
    this.maxRetries = config.maxRetries || 6;

    /**
     * Maximum number of packets that can be in the send queue at any given time.
     * @property queueSize
     * @type Number
     * @default 1024
     */
    this.queueSize = config.queueSize || 1024;

    /**
     * A queue for outgoing packets. If this queue is full further packets will not be added.
     * @property sendQueue
     * @type Array[]
     * @default []
     */
    this.sendQueue = this.sendQueue || [];

    /**
     * An array of temporarily held received packet fragments indexed by their message key.
     * @type Array[]
     * @default []
     */
    this.fragments = this.fragments || [];

    /**
     * Minimum size in bytes that a packet will broken into fragments.
     * @property fragmentSize
     * @type Number
     * @default 1310720
     */
    this.fragmentSize = config.fragmentSize || (5 * 1024 * 1024) / 2 / 2; //50% of 5mb, divide by 2 for utf-16 characters

    /**
     * The amount of time allotted to the Link to wait between expected fragment packets. If an expected fragment
     * is not received within this timeout the packet is dropped.
     * @property fragmentTimeout
     * @type Number
     * @default 1000
     */
    this.fragmentTimeout = config.fragmentTimeout || 1000; // 1 second

    //Add fragmenting capabilities
    String.prototype.chunk = function (size) {
        var res = [];
        for (var i = 0; i &lt; this.length; i += size) {
            res.push(this.slice(i, i + size));
        }
        return res;
    };

    // Hook into the system
    var self = this;
    var packet;
    var receiveStorageEvent = function (event) {
        if(event.newValue) {
            try {
                packet = JSON.parse(event.newValue);
            } catch (e) {
                ozpIwc.log.log(&quot;Parse error on &quot; + event.newValue);
                self.packetParseErrorCounter.inc();
                return;
            }
            if (packet.data.fragment) {
                self.handleFragment(packet);
            } else {
                self.forwardToPeer(packet);
            }
        }
    };
    if(ozpIwc.util.getInternetExplorerVersion() &gt;= 0) {
        window.setTimeout(function () {
            window.addEventListener(&#x27;storage&#x27;, receiveStorageEvent, false);
        }, 500);
    } else {
        window.addEventListener(&#x27;storage&#x27;, receiveStorageEvent, false);
    }

    this.peer.on(&quot;send&quot;, function (event) {
        self.send(event.packet);
    });

    this.peer.on(&quot;beforeShutdown&quot;, function () {
        window.removeEventListener(&#x27;storage&#x27;, receiveStorageEvent);
    }, this);

};

ozpIwc.KeyBroadcastLocalStorageLink.prototype.forwardToPeer=function(packet) {
    this.peer.receive(this.linkId, packet);
    this.packetsReceivedCounter.inc();
    if(packet.data.time) {
        this.latencyInTimer.mark(ozpIwc.util.now() - packet.data.time);
    }
};

/**
 * Handles fragmented packets received from the router. When all fragments of a message have been received,
 * the resulting packet will be passed on to the
 * {{#crossLink &quot;ozpIwc.KeyBroadcastLocalStorageLink/peer:property&quot;}}registered peer{{/crossLink}}.
 *
 * @method handleFragment
 * @param {ozpIwc.NetworkPacket} packet NetworkPacket containing an ozpIwc.FragmentPacket as its data property
 */
ozpIwc.KeyBroadcastLocalStorageLink.prototype.handleFragment = function (packet) {
    // Check to make sure the packet is a fragment and we haven&#x27;t seen it
    if (this.peer.haveSeen(packet)) {
        return;
    }

    var key = packet.data.msgId;

    this.storeFragment(packet);

    var defragmentedPacket = this.defragmentPacket(this.fragments[key]);

    if (defragmentedPacket) {

        // clear the fragment timeout
        window.clearTimeout(this.fragments[key].fragmentTimer);

        // Remove the last sequence from the known packets to reuse it for the defragmented packet
        var packetIndex = this.peer.packetsSeen[defragmentedPacket.srcPeer].indexOf(defragmentedPacket.sequence);
        delete this.peer.packetsSeen[defragmentedPacket.srcPeer][packetIndex];

        this.forwardToPeer(defragmentedPacket);

        delete this.fragments[key];
    }
};

/**
 *  Stores a received fragment. When the first fragment of a message is received, a timer is set to destroy the storage
 *  of the message fragments should not all messages be received.
 *
 * @method storeFragment
 * @param {ozpIwc.NetworkPacket} packet NetworkPacket containing an {{#crossLink &quot;ozpIwc.FragmentPacket&quot;}}{{/crossLink}} as its data property
 *
 * @returns {Boolean} result true if successful.
 */
ozpIwc.KeyBroadcastLocalStorageLink.prototype.storeFragment = function (packet) {
    if (!packet.data.fragment) {
        return null;
    }

    // NetworkPacket properties
    var sequence = packet.sequence;
    var srcPeer = packet.srcPeer;
    // FragmentPacket Properties
    var key = packet.data.msgId;
    var id = packet.data.id;
    var chunk = packet.data.chunk;
    var total = packet.data.total;

    if (key === undefined || id === undefined) {
        return null;
    }

    // If this is the first fragment of a message, add the storage object
    if (!this.fragments[key]) {
        this.fragments[key] = {};
        this.fragments[key].chunks = [];

        var self = this;
        self.key = key;
        self.total = total ;

        // Add a timeout to destroy the fragment should the whole message not be received.
        this.fragments[key].timeoutFunc = function () {
            self.droppedFragmentsCounter.inc(self.total);
            delete self.fragments[self.key];
        };
    }

    // Restart the fragment drop countdown
    window.clearTimeout(this.fragments[key].fragmentTimer);
    this.fragments[key].fragmentTimer = window.setTimeout(this.fragments[key].timeoutFunc, this.fragmentTimeout);

    // keep a copy of properties needed for defragmenting, the last sequence &amp; srcPeer received will be
    // reused in the defragmented packet
    this.fragments[key].total = total || this.fragments[key].total ;
    this.fragments[key].sequence = (sequence !== undefined) ? sequence : this.fragments[key].sequence;
    this.fragments[key].srcPeer = srcPeer || this.fragments[key].srcPeer;
    this.fragments[key].chunks[id] = chunk;

    // If the necessary properties for defragmenting aren&#x27;t set the storage fails
    if (this.fragments[key].total === undefined || this.fragments[key].sequence === undefined ||
        this.fragments[key].srcPeer === undefined) {
        return null;
    } else {
        this.fragmentsReceivedCounter.inc();
        return true;
    }
};

/**
 * Rebuilds the original packet sent across the keyBroadcastLocalStorageLink from the fragments it was broken up into.
 *
 * @method defragmentPacket
 * @param {ozpIwc.FragmentStore} fragments the grouping of fragments to reconstruct
 *
 * @returns {ozpIwc.NetworkPacket} result the reconstructed NetworkPacket with TransportPacket as its data property.
 */
ozpIwc.KeyBroadcastLocalStorageLink.prototype.defragmentPacket = function (fragments) {
    if (fragments.total !== fragments.chunks.length) {
        return null;
    }
    try {
        var result = JSON.parse(fragments.chunks.join(&#x27;&#x27;));
        return {
            defragmented: true,
            sequence: fragments.sequence,
            srcPeer: fragments.srcPeer,
            data: result
        };
    } catch (e) {
        return null;
    }
};

/**
 * Publishes a packet to other peers. If the sendQueue is full the send will not occur. If the TransportPacket is larger
 * than the {{#crossLink &quot;ozpIwc.KeyBroadcastLocalStorageLink/fragmentSize:property&quot;}}{{/crossLink}}, an
 * {{#crossLink &quot;ozpIwc.FragmentPacket&quot;}}{{/crossLink}} will be sent instead.
 *
 * @method send
 * @param {ozpIwc.NetworkPacket} packet
 */
ozpIwc.KeyBroadcastLocalStorageLink.prototype.send = function (packet) {
    var str;
    try {
       str = JSON.stringify(packet.data);
    } catch (e){
        this.packetsFailedCounter.inc();
        var msgId = packet.msgId || &quot;unknown&quot;;
        ozpIwc.log.error(&quot;Failed to write packet(msgId=&quot; + msgId+ &quot;):&quot; + e.message);
        return;
    }

    if (str.length &lt; this.fragmentSize) {
        this.queueSend(packet);
    } else {
        var fragments = str.chunk(this.fragmentSize);

        // Use the original packet as a template, delete the data and
        // generate new packets.
        var self = this;
        self.data= packet.data;
        delete packet.data;

        var fragmentGen = function (chunk, template) {

            template.sequence = self.peer.sequenceCounter++;
            template.data = {
                fragment: true,
                msgId: self.data.msgId,
                id: i,
                total: fragments.length,
                chunk: chunk
            };
            return template;
        };

        // Generate &amp; queue the fragments
        for (var i = 0; i &lt; fragments.length; i++) {
            this.queueSend(fragmentGen(fragments[i], packet));
        }
    }
};

/**
 * Places a packet in the {{#crossLink &quot;ozpIwc.KeyBroadcastLocalStorageLink/sendQueue:property&quot;}}{{/crossLink}}
 * if it does not already hold {{#crossLink &quot;ozpIwc.KeyBroadcastLocalStorageLink/queueSize:property&quot;}}{{/crossLink}}
 * amount of packets.
 *
 * @method queueSend
 * @param packet
 */
ozpIwc.KeyBroadcastLocalStorageLink.prototype.queueSend = function (packet) {
    if (this.sendQueue.length &lt; this.queueSize) {
        this.sendQueue = this.sendQueue.concat(packet);
        while (this.sendQueue.length &gt; 0) {
            this.attemptSend(this.sendQueue.shift());
        }
    } else {
        this.packetsFailedCounter.inc();
        ozpIwc.log.error(&quot;Failed to write packet(len=&quot; + packet.length + &quot;):&quot; + &quot; Send queue full.&quot;);
    }
};

/**
 * Recursively tries sending the packet
 * {{#crossLink &quot;ozpIwc.KeyBroadcastLocalStorageLink/maxRetries:property&quot;}}{{/crossLink}} times.
 * The packet is dropped and the send fails after reaching max attempts.
 *
 * @method attemptSend
 * @param {ozpIwc.NetworkPacket} packet
 * @param {Number} [attemptCount] number of times attempted to send packet.
 */
ozpIwc.KeyBroadcastLocalStorageLink.prototype.attemptSend = function (packet, retryCount) {

    var sendStatus = this.sendImpl(packet);
    if (sendStatus) {
        var self = this;
        retryCount = retryCount || 0;
        var timeOut = Math.max(1, Math.pow(2, (retryCount - 1))) - 1;

        if (retryCount &lt; self.maxRetries) {
            retryCount++;
            // Call again but back off for an exponential amount of time.
            window.setTimeout(function () {
                self.attemptSend(packet, retryCount);
            }, timeOut);
        } else {
            this.packetsFailedCounter.inc();
            ozpIwc.log.error(&quot;Failed to write packet(len=&quot; + packet.length + &quot;):&quot; + sendStatus);
            return sendStatus;
        }
    }
};

/**
 * Implementation of publishing packets to peers through localStorage. If the localStorage is full or a write collision
 * occurs, the send will not occur. Returns status of localStorage write, null if success.
 *
 * @todo move counter.inc() out of the impl and handle in attemptSend?
 * @method sendImpl
 * @param {ozpIwc.NetworkPacket} packet
 */
ozpIwc.KeyBroadcastLocalStorageLink.prototype.sendImpl = function (packet) {
    var sendStatus;
    try {
        var p = JSON.stringify(packet);
        localStorage.setItem(&quot;x&quot;, p);
        this.packetsSentCounter.inc();
        if(packet.data.time) {
            this.latencyOutTimer.mark(ozpIwc.util.now() - packet.data.time);
        }
        localStorage.removeItem(&quot;x&quot;);
        sendStatus = null;
    }
    catch (e) {
        if(e.message === &quot;localStorage is null&quot;){
            // Firefox about:config dom.storage.enabled = false : no mitigation with current links
            ozpIwc.util.alert(&quot;Cannot locate localStorage. Contact your system administrator.&quot;, e);
        } else if(e.code === 18){
            // cookies disabled : no mitigation with current links
            ozpIwc.util.alert(&quot;Ozone requires your browser to accept cookies. Contact your system administrator.&quot;, e);
        } else {
            // If the error can&#x27;t be mitigated, bubble it up
            sendStatus = e;
        }
    }
    finally {
        return sendStatus;
    }
};

    </pre>
</div>

                    </div>
                </div>
            </div>
        </div>
    </div>
</div>
<script src="../assets/vendor/prettify/prettify-min.js"></script>
<script>prettyPrint();</script>
<script src="../assets/js/yui-prettify.js"></script>
<script src="../assets/../api.js"></script>
<script src="../assets/js/api-filter.js"></script>
<script src="../assets/js/api-list.js"></script>
<script src="../assets/js/api-search.js"></script>
<script src="../assets/js/apidocs.js"></script>
</body>
</html>
