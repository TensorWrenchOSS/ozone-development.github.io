<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="utf-8">
    <title>app/js/bus/network/peer.js - ozpIwc</title>
    <link rel="stylesheet" href="http://yui.yahooapis.com/3.9.1/build/cssgrids/cssgrids-min.css">
    <link rel="stylesheet" href="../assets/vendor/prettify/prettify-min.css">
    <link rel="stylesheet" href="../assets/css/main.css" id="site_styles">
    <link rel="shortcut icon" type="image/png" href="../assets/favicon.png">
    <script src="http://yui.yahooapis.com/combo?3.9.1/build/yui/yui-min.js"></script>
</head>
<body class="yui3-skin-sam">

<div id="doc">
    <div id="hd" class="yui3-g header">
        <div class="yui3-u-3-4">
            
                <h1><img src="../assets/css/logo.png" title="ozpIwc"></h1>
            
        </div>
        <div class="yui3-u-1-4 version">
            <em>API Docs for: 0.2.4</em>
        </div>
    </div>
    <div id="bd" class="yui3-g">

        <div class="yui3-u-1-4">
            <div id="docs-sidebar" class="sidebar apidocs">
                <div id="api-list">
    <h2 class="off-left">APIs</h2>
    <div id="api-tabview" class="tabview">
        <ul class="tabs">
            <li><a href="#api-classes">Classes</a></li>
            <li><a href="#api-modules">Modules</a></li>
        </ul>

        <div id="api-tabview-filter">
            <input type="search" id="api-filter" placeholder="Type to filter APIs">
        </div>

        <div id="api-tabview-panel">
            <ul id="api-classes" class="apis classes">
            
                <li><a href="../classes/ozpIwc.ApiError.html">ozpIwc.ApiError</a></li>
            
                <li><a href="../classes/ozpIwc.AsyncAction.html">ozpIwc.AsyncAction</a></li>
            
                <li><a href="../classes/ozpIwc.CancelableEvent.html">ozpIwc.CancelableEvent</a></li>
            
                <li><a href="../classes/ozpIwc.Client.html">ozpIwc.Client</a></li>
            
                <li><a href="../classes/ozpIwc.CommonApiBase.html">ozpIwc.CommonApiBase</a></li>
            
                <li><a href="../classes/ozpIwc.CommonApiCollectionValue.html">ozpIwc.CommonApiCollectionValue</a></li>
            
                <li><a href="../classes/ozpIwc.CommonApiValue.html">ozpIwc.CommonApiValue</a></li>
            
                <li><a href="../classes/ozpIwc.DataApi.html">ozpIwc.DataApi</a></li>
            
                <li><a href="../classes/ozpIwc.DataApiValue.html">ozpIwc.DataApiValue</a></li>
            
                <li><a href="../classes/ozpIwc.Endpoint.html">ozpIwc.Endpoint</a></li>
            
                <li><a href="../classes/ozpIwc.EndpointRegistry.html">ozpIwc.EndpointRegistry</a></li>
            
                <li><a href="../classes/ozpIwc.Event.html">ozpIwc.Event</a></li>
            
                <li><a href="../classes/ozpIwc.FragmentPacket.html">ozpIwc.FragmentPacket</a></li>
            
                <li><a href="../classes/ozpIwc.FragmentStore.html">ozpIwc.FragmentStore</a></li>
            
                <li><a href="../classes/ozpIwc.IntentsApi.html">ozpIwc.IntentsApi</a></li>
            
                <li><a href="../classes/ozpIwc.IntentsApiDefinitionValue.html">ozpIwc.IntentsApiDefinitionValue</a></li>
            
                <li><a href="../classes/ozpIwc.IntentsApiHandlerValue.html">ozpIwc.IntentsApiHandlerValue</a></li>
            
                <li><a href="../classes/ozpIwc.IntentsApiTypeValue.html">ozpIwc.IntentsApiTypeValue</a></li>
            
                <li><a href="../classes/ozpIwc.InternalParticipant.html">ozpIwc.InternalParticipant</a></li>
            
                <li><a href="../classes/ozpIwc.KeyBroadcastLocalStorageLink.html">ozpIwc.KeyBroadcastLocalStorageLink</a></li>
            
                <li><a href="../classes/ozpIwc.LeaderGroupParticipant.html">ozpIwc.LeaderGroupParticipant</a></li>
            
                <li><a href="../classes/ozpIwc.LocalStorageLink.html">ozpIwc.LocalStorageLink</a></li>
            
                <li><a href="../classes/ozpIwc.log.html">ozpIwc.log</a></li>
            
                <li><a href="../classes/ozpIwc.MetricsRegistry.html">ozpIwc.MetricsRegistry</a></li>
            
                <li><a href="../classes/ozpIwc.metricsStats.Sample.html">ozpIwc.metricsStats.Sample</a></li>
            
                <li><a href="../classes/ozpIwc.metricsStats.UniformSample.html">ozpIwc.metricsStats.UniformSample</a></li>
            
                <li><a href="../classes/ozpIwc.metricStats.html">ozpIwc.metricStats</a></li>
            
                <li><a href="../classes/ozpIwc.metricStats.BinaryHeap.html">ozpIwc.metricStats.BinaryHeap</a></li>
            
                <li><a href="../classes/ozpIwc.metricStats.ExponentiallyDecayingSample.html">ozpIwc.metricStats.ExponentiallyDecayingSample</a></li>
            
                <li><a href="../classes/ozpIwc.metricTypes.BaseMetric.html">ozpIwc.metricTypes.BaseMetric</a></li>
            
                <li><a href="../classes/ozpIwc.metricTypes.Counter.html">ozpIwc.metricTypes.Counter</a></li>
            
                <li><a href="../classes/ozpIwc.metricTypes.Gauge.html">ozpIwc.metricTypes.Gauge</a></li>
            
                <li><a href="../classes/ozpIwc.metricTypes.Histogram.html">ozpIwc.metricTypes.Histogram</a></li>
            
                <li><a href="../classes/ozpIwc.metricTypes.Meter.html">ozpIwc.metricTypes.Meter</a></li>
            
                <li><a href="../classes/ozpIwc.MulticastParticipant.html">ozpIwc.MulticastParticipant</a></li>
            
                <li><a href="../classes/ozpIwc.NamesApi.html">ozpIwc.NamesApi</a></li>
            
                <li><a href="../classes/ozpIwc.NamesApiValue.html">ozpIwc.NamesApiValue</a></li>
            
                <li><a href="../classes/ozpIwc.NetworkPacket.html">ozpIwc.NetworkPacket</a></li>
            
                <li><a href="../classes/ozpIwc.packetRouter.html">ozpIwc.packetRouter</a></li>
            
                <li><a href="../classes/ozpIwc.PacketRouter.html">ozpIwc.PacketRouter</a></li>
            
                <li><a href="../classes/ozpIwc.Participant.html">ozpIwc.Participant</a></li>
            
                <li><a href="../classes/ozpIwc.Peer.html">ozpIwc.Peer</a></li>
            
                <li><a href="../classes/ozpIwc.policyAuth.PDP.html">ozpIwc.policyAuth.PDP</a></li>
            
                <li><a href="../classes/ozpIwc.policyAuth.SecurityAttribute.html">ozpIwc.policyAuth.SecurityAttribute</a></li>
            
                <li><a href="../classes/ozpIwc.PostMessageParticipant.html">ozpIwc.PostMessageParticipant</a></li>
            
                <li><a href="../classes/ozpIwc.PostMessageParticipantListener.html">ozpIwc.PostMessageParticipantListener</a></li>
            
                <li><a href="../classes/ozpIwc.Router.html">ozpIwc.Router</a></li>
            
                <li><a href="../classes/ozpIwc.RouterWatchdog.html">ozpIwc.RouterWatchdog</a></li>
            
                <li><a href="../classes/ozpIwc.SystemApi.html">ozpIwc.SystemApi</a></li>
            
                <li><a href="../classes/ozpIwc.SystemApiApplicationValue.html">ozpIwc.SystemApiApplicationValue</a></li>
            
                <li><a href="../classes/ozpIwc.Timer.html">ozpIwc.Timer</a></li>
            
                <li><a href="../classes/ozpIwc.TransportPacket.html">ozpIwc.TransportPacket</a></li>
            
                <li><a href="../classes/ozpIwc.TransportPacketContext.html">ozpIwc.TransportPacketContext</a></li>
            
                <li><a href="../classes/ozpIwc.util.html">ozpIwc.util</a></li>
            
                <li><a href="../classes/ozpIwcPolicies.html">ozpIwcPolicies</a></li>
            
            </ul>

            <ul id="api-modules" class="apis modules">
            
                <li><a href="../modules/bus.html">bus</a></li>
            
                <li><a href="../modules/bus.api.html">bus.api</a></li>
            
                <li><a href="../modules/bus.api.Type.html">bus.api.Type</a></li>
            
                <li><a href="../modules/bus.api.Value.html">bus.api.Value</a></li>
            
                <li><a href="../modules/bus.network.html">bus.network</a></li>
            
                <li><a href="../modules/bus.network.packets.html">bus.network.packets</a></li>
            
                <li><a href="../modules/bus.security.html">bus.security</a></li>
            
                <li><a href="../modules/bus.transport.html">bus.transport</a></li>
            
                <li><a href="../modules/bus.util.html">bus.util</a></li>
            
                <li><a href="../modules/client.html">client</a></li>
            
                <li><a href="../modules/common.html">common</a></li>
            
                <li><a href="../modules/metrics.html">metrics</a></li>
            
                <li><a href="../modules/metrics.statistics.html">metrics.statistics</a></li>
            
                <li><a href="../modules/metrics.types.html">metrics.types</a></li>
            
            </ul>
        </div>
    </div>
</div>

            </div>
        </div>
        <div class="yui3-u-3-4">
                <div id="api-options">
        Show:
        <label for="api-show-inherited">
            <input type="checkbox" id="api-show-inherited" checked>
            Inherited
        </label>

        <label for="api-show-protected">
            <input type="checkbox" id="api-show-protected">
            Protected
        </label>

        <label for="api-show-private">
            <input type="checkbox" id="api-show-private">
            Private
        </label>
        <label for="api-show-deprecated">
            <input type="checkbox" id="api-show-deprecated">
            Deprecated
        </label>

    </div>


            <div class="apidocs">
                <div id="docs-main">
                    <div class="content">
                        <h1 class="file-heading">File: app/js/bus/network/peer.js</h1>

<div class="file">
    <pre class="code prettyprint linenums">

/**
 * The peer handles low-level broadcast communications between multiple browser contexts.
 * Links do the actual work of moving the packet to other browser contexts.  The links
 * call {{#crossLink &quot;ozpIwc.Peer/receive:method&quot;}}{{/crossLink}} when they need to deliver a packet to this peer and
 * hook the {{#crossLink &quot;ozpIwc.Peer/send:method&quot;}}{{/crossLink}} event in order to send packets.
 * @class Peer
 * @namespace ozpIwc
 * @constructor
 * @mixin ozpIwc.Events
 */
ozpIwc.Peer=function() {


    /**
     * A generated random 4 byte id
     * @property selfId
     * @type String
     * @default {{#crossLink &quot;ozpIwc.util/generateId:method&quot;}}{{/crossLink}}
     */
    this.selfId=ozpIwc.util.generateId();

    this.metricPrefix=&quot;peer.&quot;+this.selfId;

    /**
     * @TODO (DOC)
     * @property sequenceCounter
     * @type Number
     * @default 0
     */
    this.sequenceCounter=0;

    /**
     * A history of packets seen from each peer. Each key is a peer name, each value is an array of the last 50 packet
     * ids seen.
     * @property packetsSeen
     * @type Object
     * @default {}
     */
    this.packetsSeen={};

    /**
     * @property knownPeers
     * @type Object
     * @default {}
     */
    this.knownPeers={};

    /**
     * Eventing module for the Peer.
     * @property events
     * @type ozpIwc.Event
     * @default ozpIwc.Event
     */
    this.events=new ozpIwc.Event();
    this.events.mixinOnOff(this);

    var self=this;

    // Shutdown handling
    this.unloadListener=function() {
        self.shutdown();
    };
    window.addEventListener(&#x27;beforeunload&#x27;,this.unloadListener);

};

/**
 * The peer has received a packet from other peers.
 * @event #receive
 *
 * @param {ozpIwc.NetworkPacket} packet
 * @param {String} linkId
 */


/**
 * A cancelable event that allows listeners to override the forwarding of
 * a given packet to other peers.
 * @event #preSend
 * @extends ozpIwc.CancelableEvent
 *
 * @param {ozpIwc.NetworkPacket} packet
 */

/**
 * Notifies that a packet is being sent to other peers.  Links should use this
 * event to forward packets to other peers.
 * @event #send
 *
 * @param {ozpIwc.NetworkPacket} packet
 */

/**
 * Fires when the peer is being explicitly or implicitly shut down.
 * @event #beforeShutdown
 */

/**
 * Number of sequence Id&#x27;s held in an entry of {{#crossLink &quot;ozpIwc.Peer/packetsSeen:property&quot;}}{{/crossLink}}
 * @property maxSeqIdPerSource
 * @static
 * @type Number
 * @default 500
 */
ozpIwc.Peer.maxSeqIdPerSource=500;

/**
 * Determine if the peer has already seen the packet in question.
 *
 * @method haveSeen
 * @param {ozpIwc.NetworkPacket} packet
 *
 * @returns {Boolean}
 */
ozpIwc.Peer.prototype.haveSeen=function(packet) {
    // don&#x27;t forward our own packets
    if (packet.srcPeer === this.selfId) {
        ozpIwc.metrics.counter(this.metricPrefix,&#x27;droppedOwnPacket&#x27;).inc();
        return true;
    }
    var seen = this.packetsSeen[packet.srcPeer];
    if (!seen) {
        seen = this.packetsSeen[packet.srcPeer] = [];
    }

    // abort if we&#x27;ve seen the packet before
    if (seen.indexOf(packet.sequence) &gt;= 0) {
        return true;
    }

    //remove oldest array members when truncate needed
    seen.unshift(packet.sequence);
    if (seen.length &gt;= ozpIwc.Peer.maxSeqIdPerSource) {
        seen.length = ozpIwc.Peer.maxSeqIdPerSource;
    }
    return false;
};

/**
 * Used by routers to broadcast a packet to network.
 *
 * Fires:
 *   - {{#crossLink &quot;ozpIwc.Peer/#preSend:event&quot;}}{{/crossLink}}
 *   - {{#crossLink &quot;ozpIwc.Peer/#send:event&quot;}}{{/crossLink}}
 *
 * @method send
 * @param {ozpIwc.NetworkPacket} packet
 */
ozpIwc.Peer.prototype.send= function(packet) {
    var networkPacket={
        srcPeer: this.selfId,
        sequence: this.sequenceCounter++,
        data: packet
    };

    var preSendEvent=new ozpIwc.CancelableEvent({&#x27;packet&#x27;: networkPacket});

    this.events.trigger(&quot;preSend&quot;,preSendEvent);
    if(!preSendEvent.canceled) {
        ozpIwc.metrics.counter(this.metricPrefix,&#x27;sent&#x27;).inc();
        if(packet.time) {
            ozpIwc.metrics.timer(this.metricPrefix,&#x27;latencyOut&#x27;).mark(ozpIwc.util.now() - packet.time);
        }
        this.events.trigger(&quot;send&quot;,{&#x27;packet&#x27;:networkPacket});
    } else {
        ozpIwc.metrics.counter(this.metricPrefix,&#x27;sendRejected&#x27;).inc();
    }
};

/**
 * Called by the links when a new packet is received.
 *
 * Fires:
 *   - {{#crossLink &quot;ozpIwc.Peer/#receive:event&quot;}}{{/crossLink}}
 *
 * @method receive
 * @param {String} linkId
 * @param {ozpIwc.NetworkPacket} packet
 */
ozpIwc.Peer.prototype.receive=function(linkId,packet) {
    // drop it if we&#x27;ve seen it before
    if(this.haveSeen(packet)) {
        ozpIwc.metrics.counter(this.metricPrefix,&#x27;dropped&#x27;).inc();
        return;
    }
    ozpIwc.metrics.counter(this.metricPrefix,&#x27;received&#x27;).inc();
    if(packet.data.time) {
        ozpIwc.metrics.timer(this.metricPrefix,&#x27;latencyIn&#x27;).mark(ozpIwc.util.now() - packet.data.time);
    }

    this.events.trigger(&quot;receive&quot;,{&#x27;packet&#x27;:packet,&#x27;linkId&#x27;: linkId});
};

/**
 * Explicitly shuts down the peer.
 *
 * Fires:
 *   - {{#crossLink &quot;ozpIwc.Peer/#receive:event&quot;}}{{/crossLink}}
 *
 * @method shutdown
 */
ozpIwc.Peer.prototype.shutdown=function() {
    this.events.trigger(&quot;beforeShutdown&quot;);
    window.removeEventListener(&#x27;beforeunload&#x27;,this.unloadListener);
};


/**
 * Various packet definitions for the network aspects of the IWC. These are not instantiable, rather guidelines for
 * conforming to classes that use them.
 * @module bus.network
 * @submodule bus.network.packets
 */

/**
 * Network Packets
 * @class NetworkPacket
 * @namespace ozpIwc
 */

/**
 * The id of the peer who broadcast this packet.
 * @property srcPeer
 * @type String
 */

/**
 * A monotonically increasing, unique identifier for this packet.
 * @property sequence
 * @type String
 */

/**
 * The payload of this packet.
 * @property data
 * @type Object
 */


/**
 * Packet format for the data property of ozpIwc.NetworkPacket when working with fragmented packets.
 * @class FragmentPacket
 * @namespace ozpIwc
 */

/**
 * Flag for knowing this is a fragment packet. Should be true.
 * @property fragment
 * @type boolean
 */

/**
 * The msgId from the TransportPacket broken up into fragments.
 * @property msgId
 * @type Number
 */

/**
 * The position amongst other fragments of the TransportPacket.
 * @property id
 * @type Number
 */

/**
 * Total number of fragments of the TransportPacket expected.
 * @property total
 * @type Number
 */

/**
 * A segment of the TransportPacket in string form.
 * @property chunk
 * @type String
 */

/**
 * Storage for Fragment Packets
 * @class ozpIwc.FragmentStore
 */

/**
 *  The sequence of the latest fragment received.
 * @property sequence
 * @type Number
 */

/**
 * The total number of fragments expected.
 * @property total
 * @type Number
 */

/**
 * The srcPeer of the fragments expected.
 * @property srcPeer
 * @type String
 */

/**
 * String segments of the TransportPacket.
 * @property chunks
 * @type Array[String]
 */

    </pre>
</div>

                    </div>
                </div>
            </div>
        </div>
    </div>
</div>
<script src="../assets/vendor/prettify/prettify-min.js"></script>
<script>prettyPrint();</script>
<script src="../assets/js/yui-prettify.js"></script>
<script src="../assets/../api.js"></script>
<script src="../assets/js/api-filter.js"></script>
<script src="../assets/js/api-list.js"></script>
<script src="../assets/js/api-search.js"></script>
<script src="../assets/js/apidocs.js"></script>
</body>
</html>
