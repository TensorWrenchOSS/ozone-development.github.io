<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="utf-8">
    <title>app/js/bus/transport/leaderGroupParticipant.js - ozpIwc</title>
    <link rel="stylesheet" href="http://yui.yahooapis.com/3.9.1/build/cssgrids/cssgrids-min.css">
    <link rel="stylesheet" href="../assets/vendor/prettify/prettify-min.css">
    <link rel="stylesheet" href="../assets/css/main.css" id="site_styles">
    <link rel="shortcut icon" type="image/png" href="../assets/favicon.png">
    <script src="http://yui.yahooapis.com/combo?3.9.1/build/yui/yui-min.js"></script>
</head>
<body class="yui3-skin-sam">

<div id="doc">
    <div id="hd" class="yui3-g header">
        <div class="yui3-u-3-4">
            
                <h1><img src="../assets/css/logo.png" title="ozpIwc"></h1>
            
        </div>
        <div class="yui3-u-1-4 version">
            <em>API Docs for: 0.2.4</em>
        </div>
    </div>
    <div id="bd" class="yui3-g">

        <div class="yui3-u-1-4">
            <div id="docs-sidebar" class="sidebar apidocs">
                <div id="api-list">
    <h2 class="off-left">APIs</h2>
    <div id="api-tabview" class="tabview">
        <ul class="tabs">
            <li><a href="#api-classes">Classes</a></li>
            <li><a href="#api-modules">Modules</a></li>
        </ul>

        <div id="api-tabview-filter">
            <input type="search" id="api-filter" placeholder="Type to filter APIs">
        </div>

        <div id="api-tabview-panel">
            <ul id="api-classes" class="apis classes">
            
                <li><a href="../classes/ozpIwc.ApiError.html">ozpIwc.ApiError</a></li>
            
                <li><a href="../classes/ozpIwc.AsyncAction.html">ozpIwc.AsyncAction</a></li>
            
                <li><a href="../classes/ozpIwc.CancelableEvent.html">ozpIwc.CancelableEvent</a></li>
            
                <li><a href="../classes/ozpIwc.Client.html">ozpIwc.Client</a></li>
            
                <li><a href="../classes/ozpIwc.CommonApiBase.html">ozpIwc.CommonApiBase</a></li>
            
                <li><a href="../classes/ozpIwc.CommonApiCollectionValue.html">ozpIwc.CommonApiCollectionValue</a></li>
            
                <li><a href="../classes/ozpIwc.CommonApiValue.html">ozpIwc.CommonApiValue</a></li>
            
                <li><a href="../classes/ozpIwc.DataApi.html">ozpIwc.DataApi</a></li>
            
                <li><a href="../classes/ozpIwc.DataApiValue.html">ozpIwc.DataApiValue</a></li>
            
                <li><a href="../classes/ozpIwc.Endpoint.html">ozpIwc.Endpoint</a></li>
            
                <li><a href="../classes/ozpIwc.EndpointRegistry.html">ozpIwc.EndpointRegistry</a></li>
            
                <li><a href="../classes/ozpIwc.Event.html">ozpIwc.Event</a></li>
            
                <li><a href="../classes/ozpIwc.FragmentPacket.html">ozpIwc.FragmentPacket</a></li>
            
                <li><a href="../classes/ozpIwc.FragmentStore.html">ozpIwc.FragmentStore</a></li>
            
                <li><a href="../classes/ozpIwc.IntentsApi.html">ozpIwc.IntentsApi</a></li>
            
                <li><a href="../classes/ozpIwc.IntentsApiDefinitionValue.html">ozpIwc.IntentsApiDefinitionValue</a></li>
            
                <li><a href="../classes/ozpIwc.IntentsApiHandlerValue.html">ozpIwc.IntentsApiHandlerValue</a></li>
            
                <li><a href="../classes/ozpIwc.IntentsApiTypeValue.html">ozpIwc.IntentsApiTypeValue</a></li>
            
                <li><a href="../classes/ozpIwc.InternalParticipant.html">ozpIwc.InternalParticipant</a></li>
            
                <li><a href="../classes/ozpIwc.KeyBroadcastLocalStorageLink.html">ozpIwc.KeyBroadcastLocalStorageLink</a></li>
            
                <li><a href="../classes/ozpIwc.LeaderGroupParticipant.html">ozpIwc.LeaderGroupParticipant</a></li>
            
                <li><a href="../classes/ozpIwc.LocalStorageLink.html">ozpIwc.LocalStorageLink</a></li>
            
                <li><a href="../classes/ozpIwc.log.html">ozpIwc.log</a></li>
            
                <li><a href="../classes/ozpIwc.MetricsRegistry.html">ozpIwc.MetricsRegistry</a></li>
            
                <li><a href="../classes/ozpIwc.metricsStats.Sample.html">ozpIwc.metricsStats.Sample</a></li>
            
                <li><a href="../classes/ozpIwc.metricsStats.UniformSample.html">ozpIwc.metricsStats.UniformSample</a></li>
            
                <li><a href="../classes/ozpIwc.metricStats.html">ozpIwc.metricStats</a></li>
            
                <li><a href="../classes/ozpIwc.metricStats.BinaryHeap.html">ozpIwc.metricStats.BinaryHeap</a></li>
            
                <li><a href="../classes/ozpIwc.metricStats.ExponentiallyDecayingSample.html">ozpIwc.metricStats.ExponentiallyDecayingSample</a></li>
            
                <li><a href="../classes/ozpIwc.metricTypes.BaseMetric.html">ozpIwc.metricTypes.BaseMetric</a></li>
            
                <li><a href="../classes/ozpIwc.metricTypes.Counter.html">ozpIwc.metricTypes.Counter</a></li>
            
                <li><a href="../classes/ozpIwc.metricTypes.Gauge.html">ozpIwc.metricTypes.Gauge</a></li>
            
                <li><a href="../classes/ozpIwc.metricTypes.Histogram.html">ozpIwc.metricTypes.Histogram</a></li>
            
                <li><a href="../classes/ozpIwc.metricTypes.Meter.html">ozpIwc.metricTypes.Meter</a></li>
            
                <li><a href="../classes/ozpIwc.MulticastParticipant.html">ozpIwc.MulticastParticipant</a></li>
            
                <li><a href="../classes/ozpIwc.NamesApi.html">ozpIwc.NamesApi</a></li>
            
                <li><a href="../classes/ozpIwc.NamesApiValue.html">ozpIwc.NamesApiValue</a></li>
            
                <li><a href="../classes/ozpIwc.NetworkPacket.html">ozpIwc.NetworkPacket</a></li>
            
                <li><a href="../classes/ozpIwc.packetRouter.html">ozpIwc.packetRouter</a></li>
            
                <li><a href="../classes/ozpIwc.PacketRouter.html">ozpIwc.PacketRouter</a></li>
            
                <li><a href="../classes/ozpIwc.Participant.html">ozpIwc.Participant</a></li>
            
                <li><a href="../classes/ozpIwc.Peer.html">ozpIwc.Peer</a></li>
            
                <li><a href="../classes/ozpIwc.policyAuth.PDP.html">ozpIwc.policyAuth.PDP</a></li>
            
                <li><a href="../classes/ozpIwc.policyAuth.SecurityAttribute.html">ozpIwc.policyAuth.SecurityAttribute</a></li>
            
                <li><a href="../classes/ozpIwc.PostMessageParticipant.html">ozpIwc.PostMessageParticipant</a></li>
            
                <li><a href="../classes/ozpIwc.PostMessageParticipantListener.html">ozpIwc.PostMessageParticipantListener</a></li>
            
                <li><a href="../classes/ozpIwc.Router.html">ozpIwc.Router</a></li>
            
                <li><a href="../classes/ozpIwc.RouterWatchdog.html">ozpIwc.RouterWatchdog</a></li>
            
                <li><a href="../classes/ozpIwc.SystemApi.html">ozpIwc.SystemApi</a></li>
            
                <li><a href="../classes/ozpIwc.SystemApiApplicationValue.html">ozpIwc.SystemApiApplicationValue</a></li>
            
                <li><a href="../classes/ozpIwc.Timer.html">ozpIwc.Timer</a></li>
            
                <li><a href="../classes/ozpIwc.TransportPacket.html">ozpIwc.TransportPacket</a></li>
            
                <li><a href="../classes/ozpIwc.TransportPacketContext.html">ozpIwc.TransportPacketContext</a></li>
            
                <li><a href="../classes/ozpIwc.util.html">ozpIwc.util</a></li>
            
                <li><a href="../classes/ozpIwcPolicies.html">ozpIwcPolicies</a></li>
            
            </ul>

            <ul id="api-modules" class="apis modules">
            
                <li><a href="../modules/bus.html">bus</a></li>
            
                <li><a href="../modules/bus.api.html">bus.api</a></li>
            
                <li><a href="../modules/bus.api.Type.html">bus.api.Type</a></li>
            
                <li><a href="../modules/bus.api.Value.html">bus.api.Value</a></li>
            
                <li><a href="../modules/bus.network.html">bus.network</a></li>
            
                <li><a href="../modules/bus.network.packets.html">bus.network.packets</a></li>
            
                <li><a href="../modules/bus.security.html">bus.security</a></li>
            
                <li><a href="../modules/bus.transport.html">bus.transport</a></li>
            
                <li><a href="../modules/bus.util.html">bus.util</a></li>
            
                <li><a href="../modules/client.html">client</a></li>
            
                <li><a href="../modules/common.html">common</a></li>
            
                <li><a href="../modules/metrics.html">metrics</a></li>
            
                <li><a href="../modules/metrics.statistics.html">metrics.statistics</a></li>
            
                <li><a href="../modules/metrics.types.html">metrics.types</a></li>
            
            </ul>
        </div>
    </div>
</div>

            </div>
        </div>
        <div class="yui3-u-3-4">
                <div id="api-options">
        Show:
        <label for="api-show-inherited">
            <input type="checkbox" id="api-show-inherited" checked>
            Inherited
        </label>

        <label for="api-show-protected">
            <input type="checkbox" id="api-show-protected">
            Protected
        </label>

        <label for="api-show-private">
            <input type="checkbox" id="api-show-private">
            Private
        </label>
        <label for="api-show-deprecated">
            <input type="checkbox" id="api-show-deprecated">
            Deprecated
        </label>

    </div>


            <div class="apidocs">
                <div id="docs-main">
                    <div class="content">
                        <h1 class="file-heading">File: app/js/bus/transport/leaderGroupParticipant.js</h1>

<div class="file">
    <pre class="code prettyprint linenums">
/**
 * @submodule bus.transport
 */

/**
 * Baseclass for APIs that need leader election.  Uses the Bully algorithm for leader election.
 *
 * Implementer is responsible for handling two events:
 *    &lt;li&gt; &lt;b&gt;&quot;becameLeaderEvent&quot;&lt;/b&gt; - participant has finished its election process and is to become the leader. Handle
 *    any logic necessary above the LeaderGroupParticipant and then trigger the participant&#x27;s event &lt;b&gt;&quot;becameLeader&quot;&lt;/b&gt;
 *    &lt;i&gt;(ex. participant.events.trigger(&quot;becameLeader&quot;)&lt;/i&gt;&lt;/li&gt;
 *    &lt;li&gt; &lt;b&gt;&quot;newLeaderEvent&quot;&lt;/b&gt; - participant has finished its election process and is to become a member. Handle any logic necessary above
 *    the LeaderGroupParticipant then trigger the participant&#x27;s event &lt;b&gt;&quot;newLeader&quot;&lt;/b&gt;
 *    &lt;i&gt;(ex. participant.events.trigger(&quot;newLeader&quot;)&lt;/i&gt;&lt;/li&gt;
 *
 * @class LeaderGroupParticipant
 * @namespace ozpIwc
 * @extends ozpIwc.InternalParticipant
 * @constructor
 *
 * @param {Object} config
 * @param {String} config.name
 *        The name of this API.
 * @param {String} [config.electionAddress=config.name+&quot;.election&quot;]
 *        The multicast channel for running elections.  
 *        The leader will register to receive multicast on this channel.
 * @param {Number} [config.priority=Math.Random]
 *        How strongly this node feels it should be leader.
 * @param {Function} [config.priorityLessThan]
 *        Function that provides a strict total ordering on the priority.  Default is &quot;&lt;&quot;.
 * @param {Number} [config.electionTimeout=250]
 *        Number of milliseconds to wait before declaring victory on an election. 
 * @param {number} [config.electionTimeout=250]
 *        Number of milliseconds to wait before declaring victory on an election.
 * @param {Object} config.states  State machine states the participant will register and react to given their assigned category.
 *        Default states listed are always applied and need not be passed in configuration.
 * @param {Object} [config.states.leader=[&#x27;leader&#x27;]]
 *        Any state that the participant should deem itself the leader of its group.
 * @param {Object} [config.states.member=[&#x27;member&#x27;]]
 *        Any state that the participant should deem itself a member (not leader) of its group.
 * @param {Object} [config.states.election=[&#x27;election&#x27;]]
 *        Any state that the participant should deem itself in an election with its group.
 * @param {Object} [config.states.queueing=[&#x27;connecting&#x27;,&#x27;election&#x27;]]
 *        Any state that the participant should block non-election messages until not in a queueing state
 */
ozpIwc.LeaderGroupParticipant=ozpIwc.util.extend(ozpIwc.InternalParticipant,function(config) {
	ozpIwc.InternalParticipant.apply(this,arguments);
    config.states = config.states || {};


	if(!config.name) {
		throw &quot;Config must contain a name value&quot;;
	}


	// Networking info
    /**
     * The name of the participant.
     * @property name
     * @type String
     * @default &quot;&quot;
     */
	this.name=config.name;

    /**
     * The election address for common LeaderGroupParticipant&#x27;s on the IWC bus.
     * @property electionAddress
     * @type String
     * @default &quot;.election&quot;
     */
	this.electionAddress=config.electionAddress || (this.name + &quot;.election&quot;);


	// Election times and how to score them
    /**
     * A numeric value to determine who the leader of the group should be.
     * @property priority
     * @type Number
     * @default {{#crossLink &quot;ozpIwc.util/now:method&quot;}}-ozpIwc.util.now(){{/crossLink}}
     */
	this.priority = config.priority || ozpIwc.defaultLeaderPriority || -ozpIwc.util.now();

    /**
     * Function to determine the lower value amongst two priorities.
     * @property priorityLessThan
     * @type Function
     * @default function( l, r) { return l &lt; r };
     */
	this.priorityLessThan = config.priorityLessThan || function(l,r) { return l &lt; r; };


    /**
     * How long a participant partakes in an election.
     * @property electionTimeout
     * @type Number
     * @default 250
     */
	this.electionTimeout=config.electionTimeout || 1000; // quarter second

    /**
     * The current state of the participant.
     *
     * The leaderGroupParticipant has the following states:
     *   - connecting
     *   - queueing
     *   - election
     *   - leader
     *   - member
     *
     * @property leaderState
     * @type String
     * @default &quot;connecting&quot;
     */
	this.leaderState=&quot;connecting&quot;;

    /**
     * Packets received from the router that are not pertinent to the election. They will be processed post election
     * if this participant becomes the leader.
     * @property electionQueue
     * @type ozpIwc.NetworkPacket[]
     * @default []
     */
	this.electionQueue=[];

    /**
     * A registry of sub-states of the Election State Machine. While leaderGroupParticipant operates on states &quot;leader&quot;,
     * &quot;member&quot;, &quot;queueing&quot;, and &quot;election&quot;, it can fire events for those states should a substate change.
     * @property states
     * @type {states|*|Object|{}}
     */
    this.states = config.states;

    /**
     * Leader sub-states of the State Machine.
     * @property states.leader
     * @type {String[]}
     * @default [&quot;leader&quot;]
     */
    this.states.leader = this.states.leader || [];
    this.states.leader = this.states.leader.concat([&quot;leader&quot;]);

    /**
     * Member sub-states of the State Machine.
     * @property states.member
     * @type {String[]}
     * @default [&quot;member&quot;]
     */
    this.states.member = this.states.member || [];
    this.states.member = this.states.member.concat([&quot;member&quot;]);

    /**
     * Election sub-states of the State Machine.
     * @property states.election
     * @type {String[]}
     * @default [&quot;election&quot;]
     */
    this.states.election = this.states.election || [];
    this.states.election = this.states.election.concat([&quot;election&quot;]);

    /**
     * Queueing sub-states of the State Machine.
     * @property states.queueing
     * @type {String[]}
     * @default [&quot;connecting&quot;, &quot;election&quot;]
     */
    this.states.queueing = this.states.queueing || [];
    this.states.queueing = this.states.queueing.concat([&quot;connecting&quot;, &quot;election&quot;]);

    /**
     * A snapshot of the current active states of the participant.
     * @propery activeStates
     * @type {Object}
     */
    this.activeStates = config.activeStates || {
        &#x27;leader&#x27;: false,
        &#x27;member&#x27;: false,
        &#x27;election&#x27;: false,
        &#x27;queueing&#x27;: true
    };

    this.changeState(&quot;connecting&quot;);


	// tracking the current leader
    /**
     * The address of the current leader.
     * @property leader
     * @type String
     * @default null
     */
	this.leader=null;

    /**
     * The priority of the current leader.
     * @property leaderPriority
     * @type Number
     * @default null
     */
	this.leaderPriority=null;

    /**
     * The type of the participant.
     * @property participantType
     * @type String
     * @default &quot;leaderGroup&quot;
     */
	this.participantType=&quot;leaderGroup&quot;;

    /**
     * The name of the participant.
     * @property name
     * @type String
     * @default &quot;&quot;
     */
	this.name=config.name;


    /**
     * An internal flag used to debounce invalid leadership attempts due to high network traffic.
     * @property toggleDrop
     * @type Boolean
     * @default false
     */
    this.toggleDrop = false;

    this.victoryTS = -Number.MAX_VALUE;
    /**
     * Fires when the participant enters an election.
     * @event #startElection
     */
	this.on(&quot;startElection&quot;,function() {
        this.toggleDrop = false;
	},this);

    /**
     * Fires when this participant becomes the leader.
     * @event #becameLeader
     *
     */
	this.on(&quot;becameLeader&quot;,function() {
        this.leader = this.address;
        this.leaderPriority = this.priority;
		this.electionQueue.forEach(function(p) {
			this.forwardToTarget(p);
		},this);
		this.electionQueue=[];
	},this);

    /**
     * Fires when a leader has been assigned and this participant is not it.
     * @event #newLeader
     */
	this.on(&quot;newLeader&quot;,function() {
		this.electionQueue=[];
	},this);



    // Handle passing of state on unload
    var self=this;
	window.addEventListener(&quot;beforeunload&quot;,function() {
        //Priority has to be the minimum possible
        self.priority=-Number.MAX_VALUE;

        if(self.activeStates.leader) {
            for (var part in self.router.participants) {
                var participant = self.router.participants[part];

                // Each leaderParticipant should report out what participants are on
                // the router so that higher level elements can clean up soon to be dead references before passing on state.
                if (participant.address) {
                    self.events.trigger(&quot;receiveEventChannelPacket&quot;, {
                        packet: self.fixPacket({
                            dst: &quot;$bus.multicast&quot;,
                            action: &quot;disconnect&quot;,
                            entity: {
                                address: participant.address,
                                participantType: participant.participantType,
                                namesResource: participant.namesResource
                            }
                        })
                    });
                }
            }
        }

        self.events.trigger(&quot;unloadState&quot;);
	});


    // Connect Metrics
    ozpIwc.metrics.gauge(&#x27;transport.leaderGroup.election&#x27;).set(function() {
        var queue = self.getElectionQueue();
        return {&#x27;queue&#x27;: queue ? queue.length : 0};
    });

    /**
     * Fires when the participant has connected to its router.
     * @event #connectedToRouter
     */
	this.on(&quot;connectedToRouter&quot;,function() {
        this.router.registerMulticast(this,[this.electionAddress,this.name]);
        var self = this;
        ozpIwc.util.setImmediate(function(){
            self.startElection();
        });

    },this);

    this.on(&quot;receive&quot;,this.routePacket,this);
});

/**
 * Retrieve the election queue. Called by closures which need access to the queue as it grows
 *
 * @method getElectionQueue
 *
 * @returns {Array} the election queue
 */
ozpIwc.LeaderGroupParticipant.prototype.getElectionQueue=function() {
    return this.electionQueue;
};


/**
 * Checks to see if the leadership group is in an election
 *
 * @method inElection
 *
 * @returns {Boolean} True if in an election state, otherwise false
 */
ozpIwc.LeaderGroupParticipant.prototype.inElection=function() {
    return !!this.electionTimer || this.activeStates.election;
};


/**
 * Checks to see if this instance is the leader of it&#x27;s group.
 *
 * @method isLeader
 *
 * @returns {Boolean} True if leader.
 */
ozpIwc.LeaderGroupParticipant.prototype.isLeader=function() {
    return this.leader === this.address;
};


/**
 * Sends an election message to the leadership group.
 *
 * @method sendElectionMessage
 * @private
 * @param {String} type The type of message -- &quot;election&quot; or &quot;victory&quot;
 */
ozpIwc.LeaderGroupParticipant.prototype.sendElectionMessage=function(type, config, callback) {
    config = config || {};
    var state = config.state || {};
    var previousLeader = config.previousLeader || this.leader;
    var opponent = config.opponent || &quot;&quot;;
    // TODO: no state should have circular references, this will eventually go away.
    try {
        JSON.stringify(state);
    } catch (ex) {
        ozpIwc.log.error(this.name,this.address,&quot;failed to send state.&quot;, ex);
        state = {};
    }

    this.send({
		&#x27;src&#x27;: this.address,
		&#x27;dst&#x27;: this.electionAddress,
		&#x27;action&#x27;: type,
		&#x27;entity&#x27;: {
			&#x27;priority&#x27;: this.priority,
            &#x27;state&#x27;: state,
            &#x27;previousLeader&#x27;: previousLeader,
            &#x27;opponent&#x27;: opponent
		}
	},callback);
};


/**
 * Sends a message to the leadership group stating victory in the current election. LeaderGroupParticipant.priority
 * included to allow rebuttal. Will only send if participant&#x27;s current state is in one of the following state categories:
 *      &lt;li&gt;leader&lt;/li&gt;
 *      &lt;li&gt;election&lt;/li&gt;
 * @returns {ozpIwc.TransportPacket} Packet returned if valid request, else false.
 */
ozpIwc.LeaderGroupParticipant.prototype.sendVictoryMessage = function(){
    if(this.activeStates.leader || this.activeStates.election) {
        return this.send({
            &#x27;src&#x27;: this.address,
            &#x27;dst&#x27;: this.electionAddress,
            &#x27;action&#x27;: &#x27;victory&#x27;,
            &#x27;entity&#x27;: {
                &#x27;priority&#x27;: this.priority
            }
        });
    } else {
        return false;
    }
};

ozpIwc.LeaderGroupParticipant.prototype.leaderQuery=function(config){
    if(this.inElection()){
        return;
    }
    this.leaderQueryTimer = window.setTimeout(function(){
        self.cancelElection();
        self.startElection();
    },this.electionTimeout);

    var self = this;
    this.sendElectionMessage(&quot;leaderQuery&quot;,{},function(response){
        window.clearTimeout(self.leaderQueryTimer);

        if(response.entity.priority &gt; self.priority) {
            this.leader = response.src;
            this.leaderPriority = response.entity.priority;
            this.victoryTS = response.time;
            self.events.trigger(&quot;newLeaderEvent&quot;);
            this.stateStore = {};
        }
    });
};

/**
 * Attempt to start a new election.
 *
 * Fires:
 *     - {{#crossLink &quot;ozpiwc.LeaderGroupParticipant/#startElection:event&quot;}{{/crossLink}}
 *     - {{#crossLink &quot;ozpiwc.LeaderGroupParticipant/#becameLeader:event&quot;}{{/crossLink}}
 *
 * @method startElection
 * @param {Object} config
 * @param {Object} config.state
 * @protected
 *
 */
ozpIwc.LeaderGroupParticipant.prototype.startElection=function(config) {
    config = config || {};
    var state = config.state || {};
    var opponent = config.opponent || &quot;&quot;;
	// don&#x27;t start a new election if we are in one
	if(this.inElection()) {
		return;
	}
    this.events.trigger(&quot;startElection&quot;);

	var self=this;
	// if no one overrules us, declare victory
	this.electionTimer=window.setTimeout(function() {
		self.cancelElection();
        self.events.trigger(&quot;becameLeaderEvent&quot;);
	},this.electionTimeout);

	this.sendElectionMessage(&quot;election&quot;, {state: state, previousLeader: this.leader, opponent: opponent});
};


/**
 * Cancels participation in an in-progress election.
 *
 * Fires:
 *     - {{#crossLink &quot;ozpiwc.LeaderGroupParticipant/#endElection:event&quot;}{{/crossLink}}
 *
 * @method cancelElection
 *
 * @protected
 */
ozpIwc.LeaderGroupParticipant.prototype.cancelElection=function() {
	if(this.electionTimer) {
        window.clearTimeout(this.electionTimer);
        this.electionTimer=null;
        this.events.trigger(&quot;endElection&quot;);
	}
};


/**
 * Receives a packet on the election control group or forwards it to the target implementation of this leadership group.
 *
 * @method routePacket
 * @param {ozpIwc.TransportPacket} packetContext
 */
ozpIwc.LeaderGroupParticipant.prototype.routePacket=function(packetContext) {
	var packet=packetContext.packet;
	packetContext.leaderState=this.leaderState;
    if(packet.src === this.address) {
        // drop our own packets that found their way here
        return;
    }
    if(packet.dst === this.electionAddress) {
        if(packet.src === this.address) {
			// even if we see our own messages, we shouldn&#x27;t act upon them
			return;
		} else if(packet.action === &quot;leaderQuery&quot;){
            this.handleLeaderQueryMessage(packetContext);
        } else if(packet.action === &quot;election&quot;) {
			this.handleElectionMessage(packet);
		} else if(packet.action === &quot;victory&quot;) {
			this.handleVictoryMessage(packet);
        }
    } else {
        this.forwardToTarget(packetContext);
	}		
};

/**
 * Forwards received packets to the target implementation of the participant. If currently in an election, messages
 * are queued.
 *
 * Fires:
 *     - {{#crossLink &quot;ozpiwc.LeaderGroupParticipant/#receiveApiPacket:event&quot;}{{/crossLink}}
 *
 * @method forwardToTarget
 *
 * @param {ozpIwc.TransportPacket} packetContext
 */
ozpIwc.LeaderGroupParticipant.prototype.forwardToTarget=function(packetContext) {
    if(this.activeStates.queueing) {
		this.electionQueue.push(packetContext);
		return;
	}
	packetContext.leaderState=this.leaderState;
	this.events.trigger(&quot;receiveApiPacket&quot;,packetContext);
};


ozpIwc.LeaderGroupParticipant.prototype.handleLeaderQueryMessage=function(electionMessage){
    if(!this.activeStates.leader){
        return;
    }
    electionMessage.replyTo({
        action: &quot;leaderResponse&quot;,
        entity: {
            priority: this.priority
        }
    });
};
	
/**
 * Respond to someone else starting an election.
 *
 * @method handleElectionMessage
 *
 * @private
 * @param {ozpIwc.TransportPacket} electionMessage
 */
ozpIwc.LeaderGroupParticipant.prototype.handleElectionMessage=function(electionMessage) {
    //If a state was received, store it case participant becomes the leader
    if(Object.keys(electionMessage.entity.state).length &gt; 0){
        this.stateStore = electionMessage.entity.state;
        this.events.trigger(&quot;receivedState&quot;);
    }

    // If knowledge of a previousLeader was received, store it case participant becomes the leader and requests state
    // from said participant.
    if(electionMessage.entity.previousLeader){
        if (electionMessage.entity.previousLeader !== this.address) {
            this.previousLeader = electionMessage.entity.previousLeader;
        }
    }


	// is the new election lower priority than us?
	if(this.priorityLessThan(electionMessage.entity.priority,this.priority) &amp;&amp; this.victoryTS &lt; electionMessage.time) {
        if(electionMessage.entity.priority === -Number.MAX_VALUE){
            this.cancelElection();
            this.activeStates.election = false;
        } else {
            if(!this.inElection()) {
                this.electionQueue = [];
            }
        }
        // Quell the rebellion!
        this.startElection({opponent: electionMessage.src});

    } else if(this.activeStates.leader) {
        // If this participant is currently the leader but will loose the election, it sends out notification that their
        // is currently a leader (for state retrieval purposes)
        this.sendElectionMessage(&quot;election&quot;, {previousLeader: this.address});

    } else {

        // Abandon dreams of leadership
        this.cancelElection();

        // If set, after canceling, the participant will force itself to a membership state. Used to debounce invalid
        // leadership attempts due to high network traffic.
        if(this.toggleDrop){
            this.toggleDrop = false;
            this.events.trigger(&quot;newLeaderEvent&quot;);
        }
	}

};


/**
 * Handle someone else declaring victory.
 *
 * Fires:
 *     - {{#crossLink &quot;ozpiwc.LeaderGroupParticipant/#newLeader:event&quot;}{{/crossLink}}
 *
 * @param {ozpIwc.TransportPacket} victoryMessage
 */
ozpIwc.LeaderGroupParticipant.prototype.handleVictoryMessage=function(victoryMessage) {
	if(this.priorityLessThan(victoryMessage.entity.priority,this.priority)) {
		// someone usurped our leadership! start an election!
            this.startElection({opponent: victoryMessage.src +&quot;USURPER&quot;});
	} else {
		// submit to the bully
		this.leader=victoryMessage.src;
		this.leaderPriority=victoryMessage.entity.priority;
        this.victoryTS = victoryMessage.time;
		this.cancelElection();
		this.events.trigger(&quot;newLeaderEvent&quot;);
        this.stateStore = {};
	}
};

/**
 * Returns the status of the participant.
 *
 * @method heartbeatStatus
 * @returns {Object}
 */
ozpIwc.LeaderGroupParticipant.prototype.heartbeatStatus=function() {
	var status= ozpIwc.Participant.prototype.heartbeatStatus.apply(this,arguments);
	status.leaderState=this.leaderState;
	status.leaderPriority=this.priority;
	return status;
};


/**
 * Changes the current state of the participant.
 * @param state {string} The state to change to.
 * @param config {object} properties to change in the participant should the state transition be valid
 * @returns {boolean}
 *      Will return true if a state transition occurred.
 *      Will not change state and return false if:
 *      &lt;li&gt;the new state was the current state&lt;/li&gt;
 *      &lt;li&gt;the new state is not a registered state @see ozpIwc.LeaderGroupParticipant&lt;/li&gt;
 */
ozpIwc.LeaderGroupParticipant.prototype.changeState=function(state,config) {
    if(state !== this.leaderState){
//        ozpIwc.log.log(this.address, this.leaderState, state);
        if(this._validateState(state)){
            for(var key in config){
                this[key] = config[key];
            }
            return true;
        }
    }
    return false;
};


/**
 *  Validates if the desired state transition is possible.
 *
 * @param state {string} The desired state to transition to.
 * @returns {boolean}
 *      Will return true if a state transition occured. &lt;/br&gt;
 *      Will not change state and return false if:
 *      &lt;li&gt;the new state was the current state&lt;/li&gt;
 *      &lt;li&gt;the new state is not a registered state&lt;/li&gt;
 * @private
 */
ozpIwc.LeaderGroupParticipant.prototype._validateState = function(state){
    var newState = {};
    var validState = false;
    for(var x in this.states) {
        if(ozpIwc.util.arrayContainsAll(this.states[x], [state])){
            newState[x] = true;
            validState = true;
        } else {
            newState[x] = false;
        }
    }
    if(validState){
        this.activeStates = newState;
        this.leaderState = state;
        return true;
    } else {
        ozpIwc.log.error(this.address, this.name, &quot;does not have state:&quot;, state);
        return false;
    }
};
    </pre>
</div>

                    </div>
                </div>
            </div>
        </div>
    </div>
</div>
<script src="../assets/vendor/prettify/prettify-min.js"></script>
<script>prettyPrint();</script>
<script src="../assets/js/yui-prettify.js"></script>
<script src="../assets/../api.js"></script>
<script src="../assets/js/api-filter.js"></script>
<script src="../assets/js/api-list.js"></script>
<script src="../assets/js/api-search.js"></script>
<script src="../assets/js/apidocs.js"></script>
</body>
</html>
