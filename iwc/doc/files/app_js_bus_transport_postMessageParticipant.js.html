<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="utf-8">
    <title>app/js/bus/transport/postMessageParticipant.js - ozpIwc</title>
    <link rel="stylesheet" href="http://yui.yahooapis.com/3.9.1/build/cssgrids/cssgrids-min.css">
    <link rel="stylesheet" href="../assets/vendor/prettify/prettify-min.css">
    <link rel="stylesheet" href="../assets/css/main.css" id="site_styles">
    <link rel="shortcut icon" type="image/png" href="../assets/favicon.png">
    <script src="http://yui.yahooapis.com/combo?3.9.1/build/yui/yui-min.js"></script>
</head>
<body class="yui3-skin-sam">

<div id="doc">
    <div id="hd" class="yui3-g header">
        <div class="yui3-u-3-4">
            
                <h1><img src="../assets/css/logo.png" title="ozpIwc"></h1>
            
        </div>
        <div class="yui3-u-1-4 version">
            <em>API Docs for: 0.2.4</em>
        </div>
    </div>
    <div id="bd" class="yui3-g">

        <div class="yui3-u-1-4">
            <div id="docs-sidebar" class="sidebar apidocs">
                <div id="api-list">
    <h2 class="off-left">APIs</h2>
    <div id="api-tabview" class="tabview">
        <ul class="tabs">
            <li><a href="#api-classes">Classes</a></li>
            <li><a href="#api-modules">Modules</a></li>
        </ul>

        <div id="api-tabview-filter">
            <input type="search" id="api-filter" placeholder="Type to filter APIs">
        </div>

        <div id="api-tabview-panel">
            <ul id="api-classes" class="apis classes">
            
                <li><a href="../classes/ozpIwc.ApiError.html">ozpIwc.ApiError</a></li>
            
                <li><a href="../classes/ozpIwc.AsyncAction.html">ozpIwc.AsyncAction</a></li>
            
                <li><a href="../classes/ozpIwc.CancelableEvent.html">ozpIwc.CancelableEvent</a></li>
            
                <li><a href="../classes/ozpIwc.Client.html">ozpIwc.Client</a></li>
            
                <li><a href="../classes/ozpIwc.CommonApiBase.html">ozpIwc.CommonApiBase</a></li>
            
                <li><a href="../classes/ozpIwc.CommonApiCollectionValue.html">ozpIwc.CommonApiCollectionValue</a></li>
            
                <li><a href="../classes/ozpIwc.CommonApiValue.html">ozpIwc.CommonApiValue</a></li>
            
                <li><a href="../classes/ozpIwc.DataApi.html">ozpIwc.DataApi</a></li>
            
                <li><a href="../classes/ozpIwc.DataApiValue.html">ozpIwc.DataApiValue</a></li>
            
                <li><a href="../classes/ozpIwc.Endpoint.html">ozpIwc.Endpoint</a></li>
            
                <li><a href="../classes/ozpIwc.EndpointRegistry.html">ozpIwc.EndpointRegistry</a></li>
            
                <li><a href="../classes/ozpIwc.Event.html">ozpIwc.Event</a></li>
            
                <li><a href="../classes/ozpIwc.FragmentPacket.html">ozpIwc.FragmentPacket</a></li>
            
                <li><a href="../classes/ozpIwc.FragmentStore.html">ozpIwc.FragmentStore</a></li>
            
                <li><a href="../classes/ozpIwc.IntentsApi.html">ozpIwc.IntentsApi</a></li>
            
                <li><a href="../classes/ozpIwc.IntentsApiDefinitionValue.html">ozpIwc.IntentsApiDefinitionValue</a></li>
            
                <li><a href="../classes/ozpIwc.IntentsApiHandlerValue.html">ozpIwc.IntentsApiHandlerValue</a></li>
            
                <li><a href="../classes/ozpIwc.IntentsApiTypeValue.html">ozpIwc.IntentsApiTypeValue</a></li>
            
                <li><a href="../classes/ozpIwc.InternalParticipant.html">ozpIwc.InternalParticipant</a></li>
            
                <li><a href="../classes/ozpIwc.KeyBroadcastLocalStorageLink.html">ozpIwc.KeyBroadcastLocalStorageLink</a></li>
            
                <li><a href="../classes/ozpIwc.LeaderGroupParticipant.html">ozpIwc.LeaderGroupParticipant</a></li>
            
                <li><a href="../classes/ozpIwc.LocalStorageLink.html">ozpIwc.LocalStorageLink</a></li>
            
                <li><a href="../classes/ozpIwc.log.html">ozpIwc.log</a></li>
            
                <li><a href="../classes/ozpIwc.MetricsRegistry.html">ozpIwc.MetricsRegistry</a></li>
            
                <li><a href="../classes/ozpIwc.metricsStats.Sample.html">ozpIwc.metricsStats.Sample</a></li>
            
                <li><a href="../classes/ozpIwc.metricsStats.UniformSample.html">ozpIwc.metricsStats.UniformSample</a></li>
            
                <li><a href="../classes/ozpIwc.metricStats.html">ozpIwc.metricStats</a></li>
            
                <li><a href="../classes/ozpIwc.metricStats.BinaryHeap.html">ozpIwc.metricStats.BinaryHeap</a></li>
            
                <li><a href="../classes/ozpIwc.metricStats.ExponentiallyDecayingSample.html">ozpIwc.metricStats.ExponentiallyDecayingSample</a></li>
            
                <li><a href="../classes/ozpIwc.metricTypes.BaseMetric.html">ozpIwc.metricTypes.BaseMetric</a></li>
            
                <li><a href="../classes/ozpIwc.metricTypes.Counter.html">ozpIwc.metricTypes.Counter</a></li>
            
                <li><a href="../classes/ozpIwc.metricTypes.Gauge.html">ozpIwc.metricTypes.Gauge</a></li>
            
                <li><a href="../classes/ozpIwc.metricTypes.Histogram.html">ozpIwc.metricTypes.Histogram</a></li>
            
                <li><a href="../classes/ozpIwc.metricTypes.Meter.html">ozpIwc.metricTypes.Meter</a></li>
            
                <li><a href="../classes/ozpIwc.MulticastParticipant.html">ozpIwc.MulticastParticipant</a></li>
            
                <li><a href="../classes/ozpIwc.NamesApi.html">ozpIwc.NamesApi</a></li>
            
                <li><a href="../classes/ozpIwc.NamesApiValue.html">ozpIwc.NamesApiValue</a></li>
            
                <li><a href="../classes/ozpIwc.NetworkPacket.html">ozpIwc.NetworkPacket</a></li>
            
                <li><a href="../classes/ozpIwc.packetRouter.html">ozpIwc.packetRouter</a></li>
            
                <li><a href="../classes/ozpIwc.PacketRouter.html">ozpIwc.PacketRouter</a></li>
            
                <li><a href="../classes/ozpIwc.Participant.html">ozpIwc.Participant</a></li>
            
                <li><a href="../classes/ozpIwc.Peer.html">ozpIwc.Peer</a></li>
            
                <li><a href="../classes/ozpIwc.policyAuth.PDP.html">ozpIwc.policyAuth.PDP</a></li>
            
                <li><a href="../classes/ozpIwc.policyAuth.SecurityAttribute.html">ozpIwc.policyAuth.SecurityAttribute</a></li>
            
                <li><a href="../classes/ozpIwc.PostMessageParticipant.html">ozpIwc.PostMessageParticipant</a></li>
            
                <li><a href="../classes/ozpIwc.PostMessageParticipantListener.html">ozpIwc.PostMessageParticipantListener</a></li>
            
                <li><a href="../classes/ozpIwc.Router.html">ozpIwc.Router</a></li>
            
                <li><a href="../classes/ozpIwc.RouterWatchdog.html">ozpIwc.RouterWatchdog</a></li>
            
                <li><a href="../classes/ozpIwc.SystemApi.html">ozpIwc.SystemApi</a></li>
            
                <li><a href="../classes/ozpIwc.SystemApiApplicationValue.html">ozpIwc.SystemApiApplicationValue</a></li>
            
                <li><a href="../classes/ozpIwc.Timer.html">ozpIwc.Timer</a></li>
            
                <li><a href="../classes/ozpIwc.TransportPacket.html">ozpIwc.TransportPacket</a></li>
            
                <li><a href="../classes/ozpIwc.TransportPacketContext.html">ozpIwc.TransportPacketContext</a></li>
            
                <li><a href="../classes/ozpIwc.util.html">ozpIwc.util</a></li>
            
                <li><a href="../classes/ozpIwcPolicies.html">ozpIwcPolicies</a></li>
            
            </ul>

            <ul id="api-modules" class="apis modules">
            
                <li><a href="../modules/bus.html">bus</a></li>
            
                <li><a href="../modules/bus.api.html">bus.api</a></li>
            
                <li><a href="../modules/bus.api.Type.html">bus.api.Type</a></li>
            
                <li><a href="../modules/bus.api.Value.html">bus.api.Value</a></li>
            
                <li><a href="../modules/bus.network.html">bus.network</a></li>
            
                <li><a href="../modules/bus.network.packets.html">bus.network.packets</a></li>
            
                <li><a href="../modules/bus.security.html">bus.security</a></li>
            
                <li><a href="../modules/bus.transport.html">bus.transport</a></li>
            
                <li><a href="../modules/bus.util.html">bus.util</a></li>
            
                <li><a href="../modules/client.html">client</a></li>
            
                <li><a href="../modules/common.html">common</a></li>
            
                <li><a href="../modules/metrics.html">metrics</a></li>
            
                <li><a href="../modules/metrics.statistics.html">metrics.statistics</a></li>
            
                <li><a href="../modules/metrics.types.html">metrics.types</a></li>
            
            </ul>
        </div>
    </div>
</div>

            </div>
        </div>
        <div class="yui3-u-3-4">
                <div id="api-options">
        Show:
        <label for="api-show-inherited">
            <input type="checkbox" id="api-show-inherited" checked>
            Inherited
        </label>

        <label for="api-show-protected">
            <input type="checkbox" id="api-show-protected">
            Protected
        </label>

        <label for="api-show-private">
            <input type="checkbox" id="api-show-private">
            Private
        </label>
        <label for="api-show-deprecated">
            <input type="checkbox" id="api-show-deprecated">
            Deprecated
        </label>

    </div>


            <div class="apidocs">
                <div id="docs-main">
                    <div class="content">
                        <h1 class="file-heading">File: app/js/bus/transport/postMessageParticipant.js</h1>

<div class="file">
    <pre class="code prettyprint linenums">
/** @namespace */
var ozpIwc=ozpIwc || {};

/**
 * @submodule bus.transport
 */

/**
 * @class PostMessageParticipant
 * @namespace ozpIwc
 * @extends ozpIwc.Participant
 *
 * @param {Object} config
 * @param {String} config.origin
 * @param {Object} config.sourceWindow
 * @param {Object} config.credentials
 */
ozpIwc.PostMessageParticipant=ozpIwc.util.extend(ozpIwc.Participant,function(config) {
	ozpIwc.Participant.apply(this,arguments);

    /**
     * The origin of the Participant.
     * @property origin
     */
    /**
     * The name of the Participant.
     * @property name
     */
	this.origin=this.name=config.origin;

    /**
     * The window of the Participant.
     * @property sourceWindow
     * @type Window
     */
	this.sourceWindow=config.sourceWindow;

    /**
     * @property credentials
     * @type
     */
    this.credentials=config.credentials;

    /**
     * The type of the participant.
     * @property participantType
     * @type  String
     * @default &quot;postMessageProxy&quot;
     */
	this.participantType=&quot;postMessageProxy&quot;;

    /**
     * @property permissions.attributes[&#x27;ozp:iwc:origin&#x27;]
     * @type String
     */
    this.permissions.pushIfNotExist(&quot;ozp:iwc:origin&quot;,this.origin);

    this.on(&quot;connectedToRouter&quot;,function() {
        this.permissions.pushIfNotExist(&#x27;ozp:iwc:address&#x27;, this.address);
        this.permissions.pushIfNotExist(&#x27;ozp:iwc:sendAs&#x27;, this.address);
        this.permissions.pushIfNotExist(&#x27;ozp:iwc:receiveAs&#x27;, this.address);
    },this);
    /**
     * @property heartBeatStatus.origin
     * @type String
     */
    this.heartBeatStatus.origin=this.origin;
});

/**
 * Receives a packet on behalf of this participant and forwards it via PostMessage.
 *
 * @method receiveFromRouterImpl
 * @param {ozpIwc.TransportPacketContext} packetContext
 */
ozpIwc.PostMessageParticipant.prototype.receiveFromRouterImpl=function(packetContext) {
    this.sendToRecipient(packetContext.packet);
};

/**
 * Sends a message to the other end of our connection.  Wraps any string mangling
 * necessary by the postMessage implementation of the browser.
 *
 * @method sendToParticipant
 * @param {ozpIwc.TransportPacket} packet
 * @todo Only IE requires the packet to be stringified before sending, should use feature detection?
 */
ozpIwc.PostMessageParticipant.prototype.sendToRecipient=function(packet) {
	ozpIwc.util.safePostMessage(this.sourceWindow,packet,this.origin);
};

/**
 * The participant hijacks anything addressed to &quot;$transport&quot; and serves it
 * directly.  This isolates basic connection checking from the router, itself.
 *
 * @method handleTransportpacket
 * @param {Object} packet
 */
ozpIwc.PostMessageParticipant.prototype.handleTransportPacket=function(packet) {
	var reply={
		&#x27;ver&#x27;: 1,
		&#x27;dst&#x27;: this.address,
		&#x27;src&#x27;: &#x27;$transport&#x27;,
		&#x27;replyTo&#x27;: packet.msgId,
		&#x27;msgId&#x27;: this.generateMsgId(),
		&#x27;entity&#x27;: {
			&quot;address&quot;: this.address
		}
	};
	this.sendToRecipient(reply);
};


/**
 * Sends a packet received via PostMessage to the Participant&#x27;s router.
 *
 * @method forwardFromPostMessage
 * @todo track the last used timestamp and make sure we don&#x27;t send a duplicate messageId
 * @param {ozpIwc.TransportPacket} packet
 * @param {type} event
 */
ozpIwc.PostMessageParticipant.prototype.forwardFromPostMessage=function(packet,event) {
	if(typeof(packet) !== &quot;object&quot;) {
		ozpIwc.log.error(&quot;Unknown packet received: &quot; + JSON.stringify(packet));
		return;
	}
	if(event.origin !== this.origin) {
		/** @todo participant changing origins should set off more alarms, probably */
		ozpIwc.metrics.counter(&quot;transport.&quot;+this.address+&quot;.invalidSenderOrigin&quot;).inc();
		return;
	}

	packet=this.fixPacket(packet);

	// if it&#x27;s addressed to $transport, hijack it
	if(packet.dst === &quot;$transport&quot;) {
		this.handleTransportPacket(packet);
	} else {
		this.router.send(packet,this);
	}
};

/**
 * @TODO (DOC)
 * Listens for PostMessage messages and forwards them to the respected Participant.
 *
 * @class PostMessageParticipantListener
 * @param {Object} config
 * @param {ozpIwc.Router} config.router
 */
ozpIwc.PostMessageParticipantListener=function(config) {
	config = config || {};

    /**
     * @property Participants
     * @type ozpiwc.PostMessageParticipant[]
     */
	this.participants=[];

    /**
     * @property router
     * @type ozpIwc.Router
     */
	this.router=config.router || ozpIwc.defaultRouter;

	var self=this;

	window.addEventListener(&quot;message&quot;, function(event) {
		self.receiveFromPostMessage(event);
	}, false);

    ozpIwc.metrics.gauge(&#x27;transport.postMessageListener.participants&#x27;).set(function() {
        return self.getParticipantCount();
    });
};

/**
 * Gets the count of known participants
 *
 * @method getParticipantCount
 *
 * @returns {Number} the number of known participants
 */
ozpIwc.PostMessageParticipantListener.prototype.getParticipantCount=function() {
    if (!this.participants) {
        return 0;
    }
    return this.participants.length;
};

/**
 * Finds the participant associated with the given window.  Unfortunately, this is an
 * o(n) algorithm, since there doesn&#x27;t seem to be any way to hash, order, or any other way to
 * compare windows other than equality.
 *
 * @method findParticipant
 * @param {Object} sourceWindow - the participant window handle from message&#x27;s event.source
 */
ozpIwc.PostMessageParticipantListener.prototype.findParticipant=function(sourceWindow) {
	for(var i=0; i&lt; this.participants.length; ++i) {
		if(this.participants[i].sourceWindow === sourceWindow) {
			return this.participants[i];
		}
	}
};

/**
 * Process a post message that is received from a peer
 *
 * @method receiveFromPostMessage
 * @param {Object} event - The event received from the &quot;message&quot; event handler
 * @param {String} event.origin
 * @param {Object} event.source
 * @param {ozpIwc.TransportPacket} event.data
 */
ozpIwc.PostMessageParticipantListener.prototype.receiveFromPostMessage=function(event) {
	var participant=this.findParticipant(event.source);
    var packet=event.data;
    if(event.source === window) {
        // the IE profiler seems to make the window receive it&#x27;s own postMessages
        // ... don&#x27;t ask.  I don&#x27;t know why
        return;
    }
	if(typeof(event.data)===&quot;string&quot;) {
		try {
            packet=JSON.parse(event.data);
        } catch(e) {
            // assume that it&#x27;s some other library using the bus and let it go
            return;
        }
	}

    var isPacket = function(packet){
        if (ozpIwc.util.isIWCPacket(packet)) {
            participant.forwardFromPostMessage(packet, event);
        } else {
            ozpIwc.log.log(&quot;Packet does not meet IWC Packet criteria, dropping.&quot;, packet);
        }
    };

	// if this is a window who hasn&#x27;t talked to us before, sign them up
	if(!participant) {

        var self = this;
        var request = {
            &#x27;subject&#x27;: {&#x27;ozp:iwc:origin&#x27;: event.origin},
            &#x27;action&#x27;: {&#x27;ozp:iwc:action&#x27;: &#x27;connect&#x27;},
            &#x27;policies&#x27;: ozpIwc.authorization.policySets.connectSet
        };
        ozpIwc.authorization.isPermitted(request)
            .success(function () {
                participant = new ozpIwc.PostMessageParticipant({
                    &#x27;origin&#x27;: event.origin,
                    &#x27;sourceWindow&#x27;: event.source,
                    &#x27;credentials&#x27;: packet.entity
                });
                self.router.registerParticipant(participant, packet);
                self.participants.push(participant);
                isPacket(packet);

            }).failure(function (err) {
                console.error(&quot;Failed to connect. Could not authorize:&quot;, err);
            });
	} else{
        isPacket(packet);
    }

};

    </pre>
</div>

                    </div>
                </div>
            </div>
        </div>
    </div>
</div>
<script src="../assets/vendor/prettify/prettify-min.js"></script>
<script>prettyPrint();</script>
<script src="../assets/js/yui-prettify.js"></script>
<script src="../assets/../api.js"></script>
<script src="../assets/js/api-filter.js"></script>
<script src="../assets/js/api-list.js"></script>
<script src="../assets/js/api-search.js"></script>
<script src="../assets/js/apidocs.js"></script>
</body>
</html>
