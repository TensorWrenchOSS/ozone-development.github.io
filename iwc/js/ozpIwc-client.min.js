var ozpIwc=ozpIwc||{};ozpIwc.AsyncAction=function(){this.callbacks={}},ozpIwc.AsyncAction.prototype.when=function(a,b,c){return c=c||this,this.resolution===a?b.apply(c,this.value):this.callbacks[a]=function(){return b.apply(c,arguments)},this},ozpIwc.AsyncAction.prototype.resolve=function(a){if(this.resolution)throw"Cannot resolve an already resolved AsyncAction";var b=this.callbacks[a];return this.resolution=a,this.value=Array.prototype.slice.call(arguments,1),b&&b.apply(this,this.value),this},ozpIwc.AsyncAction.prototype.success=function(a,b){return this.when("success",a,b)},ozpIwc.AsyncAction.prototype.failure=function(a,b){return this.when("failure",a,b)};var ozpIwc=ozpIwc||{};ozpIwc.Event=function(){this.events={}},ozpIwc.Event.prototype.on=function(a,b,c){var d=b;return c&&(d=function(){b.apply(c,arguments)},d.ozpIwcDelegateFor=b),this.events[a]=this.events[a]||[],this.events[a].push(d),d},ozpIwc.Event.prototype.off=function(a,b){this.events[a]=(this.events[a]||[]).filter(function(a){return a!==b&&a.ozpIwcDelegateFor!==b})},ozpIwc.Event.prototype.trigger=function(a,b){b=b||new ozpIwc.CancelableEvent;var c=this.events[a]||[];return c.forEach(function(a){a(b)}),b},ozpIwc.Event.prototype.mixinOnOff=function(a){var b=this;a.on=function(){return b.on.apply(b,arguments)},a.off=function(){return b.off.apply(b,arguments)}},ozpIwc.CancelableEvent=function(a){a=a||{};for(var b in a)this[b]=a[b];this.canceled=!1,this.cancelReason=null},ozpIwc.CancelableEvent.prototype.cancel=function(a){return a=a||"Unknown",this.canceled=!0,this.cancelReason=a,this};var ozpIwc=ozpIwc||{};ozpIwc.log=ozpIwc.log||{log:function(){window.console&&"function"==typeof window.console.log&&window.console.log.apply(window.console,arguments)},error:function(){window.console&&"function"==typeof window.console.error&&window.console.error.apply(window.console,arguments)}};var ozpIwc=ozpIwc||{};ozpIwc.util=ozpIwc.util||{},ozpIwc.util.generateId=function(){return Math.floor(4294967295*Math.random()).toString(16)},ozpIwc.util.now=function(){return(new Date).getTime()},ozpIwc.util.extend=function(a,b){return b.prototype=Object.create(a.prototype),b.prototype.constructor=b,b},ozpIwc.util.structuredCloneSupport=function(){if(void 0!==ozpIwc.util.structuredCloneSupport.cache)return ozpIwc.util.structuredCloneSupport.cache;var a=!1;try{window.postMessage({toString:function(){a=!0},blob:new Blob},"*")}catch(b){a=!0}return ozpIwc.util.structuredCloneSupport.cache=!a,ozpIwc.util.structuredCloneSupport.cache},ozpIwc.util.structuredCloneSupport.cache=void 0,ozpIwc.util.clone=function(a){return Array.isArray(a)||"object"==typeof a?JSON.parse(JSON.stringify(a)):a},ozpIwc.util.arrayContainsAll=function(a,b,c){return c=c||function(a,b){return a===b},b.every(function(b){return a.some(function(a){return c(a,b)})})},ozpIwc.util.objectContainsAll=function(a,b,c){c=c||function(a,b){return a===b};for(var d in b)if(!c(a[d],b[d]))return!1;return!0};var ozpIwc=ozpIwc||{};ozpIwc.Client=function(a){a=a||{},this.address="$nobody",this.replyCallbacks={},this.peerUrl=a.peerUrl;var b=document.createElement("a");b.href=this.peerUrl,this.peerOrigin=b.protocol+"//"+b.hostname,b.port&&(this.peerOrigin+=":"+b.port),this.autoPeer="autoPeer"in a?a.autoPeer:!0,this.msgIdSequence=0,this.events=new ozpIwc.Event,this.events.mixinOnOff(this),this.receivedPackets=0,this.receivedBytes=0,this.sentPackets=0,this.sentBytes=0,this.startTime=ozpIwc.util.now(),this.window=window;var c=this;this.autoPeer&&this.findPeer(),this.postMessageHandler=function(a){if(a.origin===c.peerOrigin)try{var b=a.data;"string"==typeof b&&(b=JSON.parse(a.data)),c.receive(b),c.receivedBytes+=2*a.data.length,c.receivedPackets++}catch(d){}},this.messageEventListener=window.addEventListener("message",this.postMessageHandler,!1)},ozpIwc.Client.prototype.receive=function(a){a.replyTo&&this.replyCallbacks[a.replyTo]?this.replyCallbacks[a.replyTo](a)||this.cancelCallback(a.replyTo):this.events.trigger("receive",a)},ozpIwc.Client.prototype.send=function(a,b){var c=(new Date).getTime(),d="p:"+this.msgIdSequence++,e={ver:1,src:this.address,msgId:d,time:c};for(var f in a)e[f]=a[f];b&&(this.replyCallbacks[d]=b);var g=e;return ozpIwc.util.structuredCloneSupport()||(g=JSON.stringify(e)),this.peer.postMessage(g,"*"),this.sentBytes+=g.length,this.sentPackets++,e},ozpIwc.Client.prototype.cancelCallback=function(a){var b=!1;return a&&(delete this.replyCallbacks[a],b=!0),b},ozpIwc.Client.prototype.on=function(a,b){return"connected"===a&&"$nobody"!==this.address?void b(this):this.events.on.apply(this.events,arguments)},ozpIwc.Client.prototype.off=function(){return this.events.off.apply(this.events,arguments)},ozpIwc.Client.prototype.disconnect=function(){window.removeEventListener("message",this.messageEventListener,!1),this.iframe&&document.body.removeChild(this.iframe)},ozpIwc.Client.prototype.createIframePeer=function(a){var b=this,c=function(){b.iframe=document.createElement("iframe"),b.iframe.src=a+"/iframe_peer.html",b.iframe.height=1,b.iframe.width=1,b.iframe.style="display:none !important;",b.iframe.addEventListener("load",function(){b.requestAddress()},!1),document.body.appendChild(b.iframe),b.peer=b.iframe.contentWindow};"complete"===document.readyState?c():window.addEventListener("load",c,!1)},ozpIwc.Client.prototype.findPeer=function(){this.createIframePeer(this.peerUrl)},ozpIwc.Client.prototype.requestAddress=function(){var a=this;this.send({dst:"$transport"},function(b){return a.address=b.dst,a.events.trigger("connected",a),null})};